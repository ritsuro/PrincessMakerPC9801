; "DSKCHG.ASM" PC-9801UV11 make by R.H 1989/12/19
;		1990/04/13,1990/06/11
;
;
;	ディスクチェンジャ
;
;	1991/01/23 ＤＩＳＫＩＯ．ＡＳＭのハンドル用に改造
;
;
;	［取消］1990/04/13 ＤＩＳＫＲＤ．ＡＳＭに対応している
;	［取消］その主な改造点は
;	［取消］　１）ディレクトリィテーブルを半分にした
;
;
;	ＤＳＫＯＰＮＴとＤＳＫＬＤＴをコールしているので1989/12/26版の
;	ＤＩＳＫＩＯ．ＡＳＭとリンクしなければなりません
;
;	注意！！セクターリードのエラーが有った時は
;	このバッファの位置も疑ってみる必要あります。
;	対策、ＬＩＮＫの結合順序を替えてみる等・・・・
;	（バッファＳＣＤＡＴＡがＤＭＡのバンク（２ＦＦＦＦｈ等）に
;	　またがらないようにして下さい）
;
;	ハードディスク使用時に於ては、'$dosxstop'指定をして標準ＤＯＳへの
;	事前アクセスを止めて下さい。
;
;
;	'SYSTEM.DIR'に
;
;		'$dosxstop'という、名前があった場合は
;		標準ＤＯＳの事前アクセスを止めます
;
;		"$errordsp"という、名前があった場合はエラー表示をします。
;
;		"$unit0="という、名前があった場合はユニット＃０は
;		ドライブA:,B:,C:,D:,E:,F:...のいずれになるかを変更します。
;		用法	"$unit0=C"	: ユニット＃０はドライブＣ：
;
;	1990/07/15 ＥＰＳＯＮ製ＰＣ−３８６Ｍのドライブ対策で
;	　　FDDOOR（ＦＤドライブドア開閉チェック）のセンスコマンド(04H)を
;	　　新センスコマンド(84H)に変更したが双方ともバグらしきもの
;	　　がある為、強制的にディスクを読ませるステータスを返すようにした。
;
;	1990/08/20 DKCDOR（ＦＤドライブドア開閉チェック）の廃止。
;
;
;	WIDDISK(WIDDISK.ASM) : WINDOWS/ディスクウインドウ(DSKCHG.ASM用)
;	をＣＡＬＬする。
;
;
;	ディスクＩＤの内容
;	byte
;	0-1	システムＩＤ
;	2-3	プログラムＩＤ
;	4-5	ディスク番号
;	6-23	システム予約
;	24-1023	ユーザ解放データ
;
;
;	プログラムＩＤ（MY_DISKPROG）
;	0001H : 電脳学園３
;	0002H : サイレントメビウス
;	0003H : 電脳学園１リメイク
;	0004H : プリンセス・メーカー <====
;
;
; GAME subroutine.

DEBUG	EQU	0		; デバックアセンブルフラグ
IF	DEBUG			; デバックアセンブルフラグ
INCLUDE	TSTSET.INC
ELSE
;	デバックマクロダミー化
PRV	MACRO
	ENDM
PRF	MACRO
	ENDM
PRS	MACRO
	ENDM
PRVH	MACRO
	ENDM
LC	MACRO	XX,YY
	PUSH	AX
	PUSH	BX
	MOV	AX,XX
	MOV	BX,YY
	CALL	LOCATE		; locate.
	POP	BX
	POP	BX
	ENDM
ENDIF

MY_DISKSYSNAME	EQU	1111H	; このシステムＩＤ
MY_DISKPROG	EQU	0004H	; このプログラムＩＤ(2=silent,3=DEN1,4=PRI)
MY_DISKNUMSYS	EQU	1	; このシステムディスク番号
MY_DISKNUMD2	EQU	2	; このディスク２の番号
MY_DISKNUMD3	EQU	3	; このディスク３の番号
MY_DISKNUMD4	EQU	4	; このディスク４の番号
MY_DISKNUMD5	EQU	5	; このディスク５の番号
MY_DISKNUMD6	EQU	6	; このディスク６の番号
MY_DISKNUMD7	EQU	7	; このディスク７の番号


EXTRN	INT_FDISK_BIOS:FAR	; (far) disk/FD bios.

INT_FD_BIOS	MACRO		; disk/FD bios.
;same;	INT	1BH		; disk bios.
	CALL	INT_FDISK_BIOS	; (far) FD bios.
	ENDM


;*DBG*;INCLUDE	TSTSET.INC

CODE	SEGMENT	PUBLIC	'CODE'

	ASSUME	CS:CODE,DS:DATA,ES:DATA

PUBLIC	DKCINI			; ディスクチェンジ初期処理
PUBLIC	DKCCHK			; ディスクチェンジチェック
PUBLIC	DKCSET			; ディスクチェンジセット
PUBLIC	DKCRST			; ディスクチェンジリセット
PUBLIC	DKC_HD			; ディスクチェンジ・ハードディスクチェック

;*NON*;PUBLIC	DKCIDW		; ディスクＩＤの書き込み
;*NON*;PUBLIC	DKCINS		; ディスクインサートチェック

PUBLIC	DKCMMD			; メッセージ突入モード

;*;PUBLIC DKCLD			; ディスクＩＤユーザデータの読み込み
;*;PUBLIC DKCSV			; ディスクＩＤユーザデータの書き込み
;*;PUBLIC DKCWID		; ﾃﾞｨｽｸﾁｪﾝｼﾞ表示するウインドウの選択

;
;	ＩＤセクタの後ろ１０００バイトを読み書き自由のデータとする
;


EXTRN	DSKRESET:NEAR		; disk reset.

EXTRN	DSKCLS:NEAR		; file close.

EXTRN	DSKOPNT:NEAR		; temp file open.ドライブ検索無し
EXTRN	DSKLDT:NEAR		; temp load data.ドライブ検索無し


;	時間監視用タイマカウンタ

EXTRN	TMVWT4:NEAR		; V-SYNC timer4 wait.

;	警告メッセージのためのＶＲＡＭ表示処理用

EXTRN	BRIIN:NEAR		; 明度５０％からノーマルへ
EXTRN	BRIOUT:NEAR		; 明度５０％ダウン

EXTRN	WIDDISK:NEAR		; WINDOWS/ディスクウインドウ(DSKCHG.ASM用)
;*;EXTRN	WIDMES:NEAR	; メッセージ・ウインドウ
				; その引数
				; -I- BX : 1=ウインドウ・オープン
				;        : 2=ウインドウ・クローズ
				;        : 3=ウインドウ・メッセージ／上段
				;        : 4=ウインドウ・メッセージ／中段
				;        : 5=ウインドウ・メッセージ／下段
				;  DS:SI : メッセージ・アドレス

EXTRN	MUSINI:NEAR		; マウスの初期化
EXTRN	MUSRED:NEAR		; マウス読み込み
EXTRN	MUSSHT:NEAR		; マウス読み込み・ワンショット
EXTRN	MUSSET:NEAR		; マウス座標セット
EXTRN	MUSSTB:NEAR		; マウスボタンセット
EXTRN	MUSSTP:NEAR		; マウスの終了
EXTRN	MUSWAT:NEAR		; マウスボタンＯＦＦ待ち


TIME_DKCMSG		EQU	40	; メッセージ時間
TIME_WINDOW		EQU	1	; ウインドウインターバル時間

DCYL_ID			EQU	0	; ディスクＩＤ　シリンダ番号（Ｃ）
DHEAD_ID		EQU	1	; ディスクＩＤ　ヘッド番号（Ｈ）
DSECR_ID		EQU	3	; ディスクＩＤ　セクタ番号（Ｒ）
;
ID_LEN			EQU	10	; ディスクＩＤバイト数
;
DIRTABLE_MAX		EQU	400	; ディレクトリィファイル行数数＜＝＝
;
DIRTABLE_NM_LEN		EQU	13+2	; ディレクトリィﾃｰﾌﾞﾙの１本のバイト数
DIRTABLE_OF_DNO		EQU	11	; ディレクトリィ・ドライブ番号ｵﾌｾｯﾄ
DIRTABLE_OF_NAM		EQU	0	; ディレクトリィ・ファイル名ｵﾌｾｯﾄ
;
DRVNUMMAX_FIX		EQU	4	; １ＭＦＤ固定ドライブ数
;
FLNLEN		EQU	8		; ファイル名の長さ
FLTLEN		EQU	3		; 拡張子の長さ
;					; 各オフセット値
FDMNAM		EQU	0		; ファイル名
FDMTYP		EQU	8H		; 拡張子
FDMATR		EQU	0BH		; ファイル属性
FDMSYS		EQU	0CH		; システム予約
FDMTIM		EQU	16H		; ファイル更新時刻
FDMDAT		EQU	18H		; ファイル更新年月日
FDMCLS		EQU	1AH		; ファイルの最初のクラスタ
FDMSIZ		EQU	1CH		; ファイルサイズ
;		５’２ＨＤの場合です
DIRMAX		EQU	192		; ディレクトリ最大数
SEC_BYTE	EQU	1024		; セクタバイト数
FATSECTOR 	EQU	4		; ＦＡＴテーブルセクタ数
ROOTSECTOR 	EQU	6		; ＲＯＯＴＤＩＲセクタ数
CLAST_OFFSET	EQU	8+1		; クラスタ開始位置のセクタオフセット
;
DISK_RESULT_TOP	EQU	0564H		; リザルトステータス情報アドレス
DISK_EQUIP	EQU	055CH		; 接続ユニット
RDISK_EQUIP	EQU	0488H		; ＲＡＭドライブ接続状況識別ビット
;
DISK_STATUS_DB	EQU	20H		; DMA Boundary. メモリアドレスがＤＭＡ
					; に向いていない（バンクにまたがった）
DISK_STATUS_NR	EQU	60H		; Not Ready. ユニットがノットレディ状態
;
READ_RETCOUNT 	EQU	1		; リード・リトライ回数
WRITE_RETCOUNT 	EQU	10		; セクタ書き込み・リトライ回数
;
CHR_LF		EQU	0AH		; ＬＦ（ラインフィード）
CHR_CR		EQU	0DH		; ＣＲ（キャリッジリターン）
CHR_EQUAL	EQU	'='		; ＝　イコール
CHR_DELIM	EQU	','		; ，　デリミタ



;	ＰＲＩＮＴＭ	”表示文字列”

EXTRN	TXTBOX:NEAR	; テキスト属性ＢＯＸセット
EXTRN	CLS:NEAR
EXTRN	CHPUT:NEAR
EXTRN	PRINT:NEAR
EXTRN	LOCATE:NEAR

PRINTM	MACRO	STRING
	LOCAL	L1,L2
	PUSH	SI
	JMP	L2
DATA	SEGMENT	PUBLIC	'DATA'
	EVEN
L1	DB	STRING,0DH,0AH,0
	EVEN
DATA	ENDS
L2:	MOV	SI,OFFSET L1
	CALL	MSGPRN
;*DBG*;	CALL	PRINT
	POP	SI
ENDM


;	ＰＲＩＮＴＳＩ

PRINTSI	MACRO	STRING
	PUSH	SI
	CALL	MSGPRN
;*DBG*;	CALL	PRINT
	POP	SI
ENDM

PRVV	MACRO	STRING,PARAM
	LOCAL	L1,L2
	PUSH	SI
	PUSH	DX
	PUSH	SI
	JMP	L2
DATA	SEGMENT	PUBLIC	'DATA'
	EVEN
L1	DB	STRING,0
	EVEN
DATA	ENDS
L2:	MOV	SI,OFFSET L1
	EXTRN	PRINT:NEAR
	CALL	PRINT
	POP	SI
	MOV	DX,PARAM
	EXTRN	HEXSTR:NEAR
	CALL	HEXSTR
	CALL	PRINT
	EXTRN	LFPRN:NEAR	;
	CALL	LFPRN		; line feed.
	POP	DX
	POP	SI
	ENDM



;	ディスクチェンジ初期処理

DKCINI	PROC	NEAR
	CALL	MSG_START	; メッセージスタート

	CALL	CURDIRFILERD	; カレントからﾃﾞｨﾚｸﾄﾘﾌｧｲﾙ読み込み
	CMP	AX,0		; 0:normal.
	JE	DKCINI_DSKCHK	; 成功したらこのファイルでいこう！

	CALL	INSSYS		; システムディスクを挿入させる
	CALL	DIRFILEREAD	; ディレクトリィファイル読み込み

DKCINI_DSKCHK:
				; ＄ｕｎｉｔ０＝

	MOV	SI,OFFSET UNIT0	; ユニット＃０はドライブ何"$unit0="
	CALL	KFLNSET		; 指定ファイル名のカラム合わせ
	CALL	DIRSCH		; ディレクトリィサーチ
	CMP	AX,0		; 0=見つからない
	JE	DKCINI65	;
	MOV	AL,DIRNAME[7]	; 対象ファイル名
	SUB	AL,'A'		;
	MOV	DRIVENAME_SFT,AL ; ドライブ名と2HDユニット番号のズレ
	JMP	DKCINI66	;
DKCINI65:
	MOV	DRIVENAME_SFT,0	; ドライブ名と2HDユニット番号のズレ
DKCINI66:
				; ＄ｄｏｓｘｓｔｏｐ

	MOV	SI,OFFSET DOSXSTOP ; 標準ＤＯＳのアクセスを止めます
	CALL	KFLNSET		; 指定ファイル名のカラム合わせ
	CALL	DIRSCH		; ディレクトリィサーチ
	CMP	AX,0		; 0=見つからない
	JE	DKCINI71	;
	MOV	DOSSTP,1	; 0=通常,1=標準ＤＯＳのアクセスを止めます
	JMP	DKCINI72	;
DKCINI71:
	MOV	DOSSTP,0	; 0=通常,1=標準ＤＯＳのアクセスを止めます
DKCINI72:
				; ＄ｅｒｒｏｒｄｓｐ

	MOV	SI,OFFSET ERRORDSP ; エラー表示ＯＮ
	CALL	KFLNSET		; 指定ファイル名のカラム合わせ
	CALL	DIRSCH		; ディレクトリィサーチ
	CMP	AX,0		; 0=見つからない
	JE	DKCINI73	;
	MOV	FLAG_ERR_OUT,1	; 0=エラー表示抑制,1=エラー表示
	JMP	DKCINI74	;
DKCINI73:
	MOV	FLAG_ERR_OUT,0	; 0=エラー表示抑制,1=エラー表示
DKCINI74:
	CALL	MSG_STOP	; メッセージストップ
	RET
DKCINI	ENDP



;	ディスクチェンジチェック
;	-I- DS:SI : ファイル名
;	-O- DS:SI :(OFFSET DIRNAME) 対象ファイル名
;	    AX    : 0=文字列見つかった, 1=見つからない

DKCCHK	PROC	NEAR
	MOV	FILE_NAME_ADRS,SI	; ファイル名
	CALL	MSG_START		; メッセージスタート

	CALL	KFLNSET			; 指定ファイル名のカラム合わせ
	CALL	DIRSCH			; ディレクトリィサーチ
	CMP	AX,0			; 0=見つからない
	JE	DKCCHK_NONE		;

	CMP	DIRDISK,0		; 対象ディスク番号＝０、の場合は
	JE	DKCCHK_CURRENT		; カレントディスクリードの指定

	CALL	INSDSK			; ディスクを挿入させる

	CALL	KFLHANDLE		; ハンドル用パス名編集
	MOV	SI,OFFSET DIRHANDLEPATH	; ハンドル用パス名 "A:12345678.123",0

	MOV	AX,0			; 0=文字列見つかった
	JMP	DKCCHK_RET		;
DKCCHK_CURRENT:
	MOV	DRVNUM,-1		; 指定ドライブ番号（−１はカレント）
	CALL	KFLHANDLE		; ハンドル用パス名編集
	MOV	SI,OFFSET DIRHANDLEPATH	; ハンドル用パス名 "A:12345678.123",0

	MOV	AX,0			; 0=文字列見つかった
	JMP	DKCCHK_RET		;
DKCCHK_NONE:
	CALL	DKCMSG			; 見つからないメッセージ
	MOV	AX,1			; 1=見つからない
	JMP	DKCCHK_RET		;
DKCCHK_RET:
	CALL	MSG_STOP		; メッセージストップ
	RET
DKCCHK	ENDP



;	ディスクチェンジセット
;	-I- AX : ディスク番号
;	-O- DX : (DRVNUM+1)ドライブ番号(1-4)

DKCSET	PROC	NEAR
	MOV	DIRDISK,AX	; 対象ディスク番号
	CALL	MSG_START	; メッセージスタート
	CALL	INSDSK		; ディスクを挿入させる
	CALL	MSG_STOP	; メッセージストップ
	MOV	DX,DRVNUM	; 指定ディスクのドライブ番号
	INC	DX		;
	RET
DKCSET	ENDP


;	ディスクチェンジリセット

DKCRST	PROC	NEAR
	MOV	DISK_DOOR_INI[0],0FFH	; ディスク開閉初期ﾌﾗｸﾞ
	MOV	DISK_DOOR_INI[1],0FFH	; ディスク開閉初期ﾌﾗｸﾞ
	MOV	DISK_DOOR_INI[2],0FFH	; ディスク開閉初期ﾌﾗｸﾞ
	MOV	DISK_DOOR_INI[3],0FFH	; ディスク開閉初期ﾌﾗｸﾞ
	RET
DKCRST	ENDP


;	ディスクチェンジ・ハードディスクチェック
;	-O- AX : 0=ＦＤ,1=ＨＤ

DKC_HD	PROC	NEAR
	CMP	DOSSTP,1	; 0=通常,1=標準ＤＯＳのアクセスを止めます
	JE	DKC_HD_HD	;
DKC_HD_FD:
	MOV	AX,0		; 0=ＦＤ
	RET
DKC_HD_HD:
	MOV	AX,1		; 1=ＨＤ
	RET
DKC_HD	ENDP


;*NON*;
;*NON*;;	ディスクＩＤの書き込み
;*NON*;;	-I- AX : ドライブ番号（１ー４）
;*NON*;;	    DX : ディスク番号
;*NON*;;	-O- AX : 0=通常
;*NON*;;	       : 1=ディスクはセットされていない
;*NON*;;	       : 2=違うディスクみたい
;*NON*;
;*NON*;DKCIDW	PROC	NEAR
;*NON*;	PUSH	DX
;*NON*;
;*NON*;	DEC	AX		; ドライブ番号
;*NON*;
;*NON*;	PRV	"ドライブ番号=",AX
;*NON*;	PRV	"ディスク番号=",DX
;*NON*;
;*NON*;	MOV	DRVNUM,AX	; １ＭＦＤドライブ番号（０ー３）
;*NON*;
;*NON*;	MOV	AX,MY_DISKSYSNAME	; このシステムＩＤ
;*NON*;	MOV	ID_DISKSYSNAME,AX	; システムＩＤ
;*NON*;
;*NON*;	MOV	AX,MY_DISKPROG		; このプログラムＩＤ
;*NON*;	MOV	ID_DISKPROG,AX		; プログラムＩＤ
;*NON*;
;*NON*;	MOV	ID_DISKNUMBER,DX	; ディスク番号
;*NON*;
;*NON*;	CALL	IDPUT		; 汎用変数の内容をＩＤテーブルへセット
;*NON*;
;*NON*;	CALL	DSKIDSET	; ディスクＩＤの書き込み
;*NON*;
;*NON*;	PRV	"0=通常,1=セットされていない,2=違うディスク AX=",AX
;*NON*;
;*NON*;	POP	DX
;*NON*;	RET
;*NON*;DKCIDW	ENDP
;*NON*;


;*NON*;;	ディスクインサートチェック
;*NON*;;	-I- DS:SI : ファイル名
;*NON*;;	-O- AX : 0=対象ディスクはセットされています
;*NON*;;	         1=対象ディスクが挿入されていません
;*NON*;;	         2=見つからない
;*NON*;;	    BX : 対象ディスクのドライブ番号
;*NON*;
;*NON*;DKCINS	PROC	NEAR
;*NON*;	MOV	FILE_NAME_ADRS,SI	; ファイル名
;*NON*;
;*NON*;	CALL	KFLNSET		; 指定ファイル名のカラム合わせ
;*NON*;	CALL	DIRSCH		; ディレクトリィサーチ
;*NON*;	CMP	AX,0		; 0=見つからない
;*NON*;	JE	DKCINS_NONE	;
;*NON*;
;*NON*;	CMP	DIRDISK,0	; 対象ディスク番号＝０、の場合は
;*NON*;	JE	DKCINS_SET	; セットされている
;*NON*;
;*NON*;	MOV	DX,DIRDISK	; 対象ディスク番号
;*NON*;	MOV	SCH_DISKID,DX	; 検索ディスクＩＤ
;*NON*;	CALL	SYSDRVCHK	; 対象ディスクのドライブ検索
;*NON*;	MOV	BX,DRVNUM	; 対象ディスクのドライブ番号
;*NON*;	RET
;*NON*;
;*NON*;DKCINS_SET:			;
;*NON*;	MOV	AX,0		; 対象ディスクはセットされています
;*NON*;	RET
;*NON*;DKCINS_NONE:			;
;*NON*;	MOV	AX,2		; 0=見つからない
;*NON*;	RET
;*NON*;DKCINS	ENDP
;*NON*;

;*;
;*;;	ディスクＩＤユーザデータの読み込み
;*;;	-I- DX : データバッファのセグメント
;*;;	    DI : データバッファのオフセット
;*;;	    CX : 読み込みデータバイト数
;*;;	-O- DX:[DI] : 読み込みデータ
;*;
;*;DKCLD	PROC	NEAR
;*;	PUSH	CX
;*;	PUSH	DX
;*;	PUSH	DI
;*;
;*;	CALL	MSG_START	; メッセージスタート
;*;
;*;	CALL	INSSYS		; システムディスクを挿入させる
;*;
;*;	MOV	AX,DRVNUMSYS	; システムドライブ番号
;*;	CALL	READIDSEC	; ＩＤセクタの読みだし
;*;
;*;	POP	DI
;*;	POP	DX
;*;	POP	CX
;*;
;*;	MOV	ES,DX			;
;*;	MOV	SI,SCADRS		; セクタバッファアドレス
;*;	ADD	SI,24			; セクタのデータ−＞ユーザバッファ
;*;	REP	MOVSB			;
;*;
;*;	CALL	MSG_STOP	; メッセージストップ
;*;	RET
;*;DKCLD	ENDP
;*;
;*;
;*;
;*;;	ディスクＩＤユーザデータの書き込み
;*;;	-I- DX : データバッファのセグメント
;*;;	    SI : データバッファのオフセット
;*;;	    CX : 書き込みデータバイト数
;*;;	    DX:[SI] : 書き込みデータ
;*;
;*;DKCSV	PROC	NEAR
;*;	PUSH	CX
;*;	PUSH	DX
;*;	PUSH	SI
;*;
;*;	CALL	MSG_START	; メッセージスタート
;*;
;*;	CALL	INSSYS		; システムディスクを挿入させる
;*;
;*;	MOV	AX,DRVNUMSYS	; システムドライブ番号
;*;	CALL	READIDSEC	; ＩＤセクタの読みだし
;*;
;*;	MOV	AX,DRVNUMSYS	; システムドライブ番号
;*;	MOV	DRVNUM,AX	; １ＭＦＤドライブ番号（０ー３）
;*;	CALL	IDGET		; ＩＤテーブルの内容を汎用変数へセット
;*;
;*;	POP	SI
;*;	POP	DX
;*;	POP	CX
;*;
;*;	PUSH	DS
;*;
;*;	MOV	DI,SCADRS		; セクタバッファアドレス
;*;	ADD	DI,24			; セクタのデータ−＞ユーザバッファ
;*;	MOV	AX,DS			;
;*;	MOV	ES,AX			;
;*;	MOV	DS,DX			;
;*;	REP	MOVSB			;
;*;
;*;	POP	DS
;*;
;*;	MOV	AX,DRVNUMSYS	; システムドライブ番号
;*;	MOV	DRVNUM,AX	; １ＭＦＤドライブ番号（０ー３）
;*;	CALL	IDPUT		; 汎用変数の内容をＩＤテーブルへセット
;*;
;*;	MOV	AX,DRVNUMSYS	; システムドライブ番号
;*;	CALL	WRITEIDSEC	; ＩＤセクタの書き込み
;*;
;*;	CALL	MSG_STOP	; メッセージストップ
;*;	RET
;*;DKCSV	ENDP




;	ディレクトリィサーチ
;	-I- FLNAME  : ファイル名
;	-O- AX      : 1=文字列見つかった,0=見つからない
;	    DIRDISK : 対象ディスク番号
;	    DIRNAME : 対象ファイル名

DIRSCH	PROC	NEAR
	PRS	"ディレクトリィサーチ　ファイル名＝",FLNAME

	CALL	STRSCH			; 文字列検索
	CMP	AX,0			;
	JE	DIRSCH_NONE		;
 
	MOV	SI,BX			; 見つかった文字列先頭
	ADD	SI,DIRTABLE_OF_DNO	; ディレクトリィ・ドライブ番号
	MOV	AL,DS:[SI]		; 対象ディスク番号(CHAR)
	SUB	AL,'0'			;
	MOV	AH,0			;
	MOV	DIRDISK,AX		; 対象ディスク番号(int)

	MOV	SI,BX			; 見つかった文字列先頭
	ADD	SI,DIRTABLE_OF_NAM	; ディレクトリィ・ファイル名
	MOV	DI,OFFSET DIRNAME	; 対象ファイル名
	MOV	AX,DS			;
	MOV	ES,AX			;
	MOV	CX,FLNLEN+FLTLEN  ; 拡張子の長さ+ファイル名の長さ
	REP	MOVSB			;

	MOV	AX,1	; 1=文字列見つかった
	JMP	DIRSCH_RET
DIRSCH_NONE:
	MOV	AX,0	; 0=見つからない
	JMP	DIRSCH_RET
DIRSCH_RET:
	PRV	"対象ディスク番号=",DIRDISK
	PRS	"対象ファイル名=",DIRNAME
	PRV	"1=文字列見つかった,0=見つからない AX=",AX
	RET
DIRSCH	ENDP



;	文字列検索
;	'，', '＝'チェック付き
;	-I- FLNAME  : ファイル名
;	    DIRTABLE: ディレクトリィテーブル
;	-O- DS:BX   : 見つかった文字列先頭
;	    AX      : 1=文字列見つかった,0=見つからない

STRSCH	PROC	NEAR
	MOV	AX,DS
	MOV	ES,AX
	MOV	SI,OFFSET FLNAME	; ファイル名
	MOV	DI,OFFSET DIRTABLE	; ディレクトリィテーブル
STRSCH2:
	MOV	DX,SI			; search string.
	MOV	BX,DI			; string table.
	MOV	CX,FLNLEN+FLTLEN	; ファイル名の長さ+拡張子の長さ
STRSCH3:
	CMPSB				; dest.
	JNE	STRSCH_NEXT		; 違う
	CMP	ES:[DI],BYTE PTR CHR_EQUAL	; ＝　イコール
	JE	STRSCH_SCH			; 見つかりました
	CMP	ES:[DI],BYTE PTR CHR_DELIM	; ，　デリミタ
	JE	STRSCH_SCH			; 見つかりました
	LOOP	STRSCH3			;
	JMP	STRSCH_SCH		; 見つかりました

STRSCH_NEXT:				;
	MOV	SI,DX			; search string.
	ADD	BX,DIRTABLE_NM_LEN	; ﾃｰﾌﾞﾙの１本のバイト数
	MOV	DI,BX			; string table.
	CMP	BYTE PTR DS:[DI],0	; テーブル終わり？
	JE	STRSCH_NONE		;

	JMP	STRSCH2			;

STRSCH_SCH:
	MOV	AX,1			; 1=文字列見つかった
	RET
STRSCH_NONE:
	MOV	AX,0			; 0=見つからない
	RET
STRSCH	ENDP



;	カレントからディレクトリィファイル読み込み
;	-o- AX : 0:normal.
;	         1:error.

CURDIRFILERD	PROC	NEAR
	MOV	SI,OFFSET SYSDIRNAM	; ディレクトリィファイル名
	CALL	DSKOPNT			; temp file open.
	CMP	AX,0			; -o- AX : 0:normal.
	JNE	CURDIRFILERD_EXIT	;	   1:open error.

	CALL	DSKCLS			; file close.

	MOV	SI,OFFSET SYSDIRNAM	; ディレクトリィファイル名
	MOV	DX,SEG DATA		; dest segment address.
	MOV	DI,OFFSET DIRTABLE	; dest offset  address.
	MOV	CX,DIRTABLE_MAX*DIRTABLE_NM_LEN	; data length.
	CALL	DSKLDT			; temp load data.ドライブ検索無し

CURDIRFILERD_EXIT:
	PRV	"カレントからﾃﾞｨﾚｸﾄﾘﾌｧｲﾙの読み込み　AX=",AX
	RET
CURDIRFILERD	ENDP



;	ディレクトリィファイル読み込み
;	-I- DRVNUMSYS : システムドライブ番号
;	-o- AX : 0:normal.
;	         1:error.

DIRFILEREAD	PROC	NEAR
	MOV	BX,DRVNUMSYS		; システムドライブ番号
	MOV	AL,DS:DRIVENAME_TBL[BX]	; ドライブ名テーブル 0=A,1=B,2=C,3=D
	ADD	AL,DRIVENAME_SFT	; ドライブ名と2HDユニット番号のズレ
	MOV	SYSDIRPATH,AL		; ディレクトリィファイル・パス名

	MOV	SI,OFFSET SYSDIRPATH	; ディレクトリィファイル・パス名
	MOV	DX,SEG DATA		; dest segment address.
	MOV	DI,OFFSET DIRTABLE	; dest offset  address.
	MOV	CX,DIRTABLE_MAX*DIRTABLE_NM_LEN	; data length.
	CALL	DSKLDT			; temp load data.ドライブ検索無し

	PRV	"ディレクトリィファイルの読み込み　AX=",AX
	RET
DIRFILEREAD	ENDP



;	システムディスクを挿入させる
;	-O- DRVNUMSYS : システムドライブ番号

INSSYS	PROC	NEAR
	MOV	AX,MY_DISKNUMSYS; このシステムディスク番号
	MOV	SCH_DISKID,AX	; 検索ディスクＩＤ
	CALL	SYSDRVCHK	; 対象ディスクのドライブ検索
	CMP	AX,0		; 0=システムディスクはセットされている
	JE	INSSYS_OK	;

	MOV	AX,MY_DISKNUMSYS; このシステムディスク番号
	MOV	SCH_DISKID,AX	; 検索ディスクＩＤ
	CALL	MSG_DISKSET	; ディスクセットのメッセージ

	MOV	AX,MY_DISKNUMSYS; このシステムディスク番号
	MOV	SCH_DISKID,AX	; 検索ディスクＩＤ
	CALL	INSDRIVE_WAIT	; ドライブにセットされるのを待つ
INSSYS_OK:
	MOV	AX,DRVNUM	; １ＭＦＤドライブ番号（０ー３）
	MOV	DRVNUMSYS,AX	; システムドライブ番号
	RET
INSSYS	ENDP



;	指定ディスクを挿入させる
;	-I- DIRDISK : 対象ディスク番号
;	-O- DRVNUM  : 指定ディスクのドライブ番号

INSDSK	PROC	NEAR
	PRV	"対象ディスク番号=",DIRDISK 

	MOV	AX,DIRDISK	; 対象ディスク番号
	MOV	SCH_DISKID,AX	; 検索ディスクＩＤ
	CALL	SYSDRVCHK	; 対象ディスクのドライブ検索
	CMP	AX,0		; 0=システムディスクはセットされている
	JE	INSDSK_OK	;

	MOV	AX,DIRDISK	; 対象ディスク番号
	MOV	SCH_DISKID,AX	; 検索ディスクＩＤ
	CALL	MSG_DISKSET	; ディスクセットのメッセージ

	CALL	DSKRESET	; disk reset.

	MOV	AX,DIRDISK	; 対象ディスク番号
	MOV	SCH_DISKID,AX	; 検索ディスクＩＤ
	CALL	INSDRIVE_WAIT	; ドライブにセットされるのを待つ
INSDSK_OK:
	PRV	"指定ディスクのドライブ番号=",DRVNUM
	RET
INSDSK	ENDP



;	ディスクセットのメッセージ
;	-I- SCH_DISKID : 検索ディスクＩＤ

MSG_DISKSET	PROC	NEAR
	CMP	SCH_DISKID,MY_DISKNUMSYS ; このシステムディスク
	JNE	MSG_DISKSET1
	PRINTM	"ドライブ１にディスクＡをいれて下さい"
	JMP	MSG_DISKSET99
MSG_DISKSET1:
	CMP	SCH_DISKID,MY_DISKNUMD2	; このデータディスク２
	JNE	MSG_DISKSET2
	PRINTM	"ドライブ２にディスクＢをいれて下さい"
	JMP	MSG_DISKSET99
MSG_DISKSET2:
	CMP	SCH_DISKID,MY_DISKNUMD3	; このデータディスク３
	JNE	MSG_DISKSET3
	PRINTM	"ドライブ２にディスクＣをいれて下さい"
	JMP	MSG_DISKSET99
MSG_DISKSET3:
	CMP	SCH_DISKID,MY_DISKNUMD4	; このデータディスク４
	JNE	MSG_DISKSET4
	PRINTM	"ドライブ２にディスクＤをいれて下さい"
	JMP	MSG_DISKSET99
MSG_DISKSET4:
	CMP	SCH_DISKID,MY_DISKNUMD5	; このデータディスク５
	JNE	MSG_DISKSET5
	PRINTM	"ドライブ２にディスクＥをいれて下さい"
	JMP	MSG_DISKSET99
MSG_DISKSET5:
	CMP	SCH_DISKID,MY_DISKNUMD6	; このデータディスク６
	JNE	MSG_DISKSET6
	PRINTM	"ドライブ２にディスクＦをいれて下さい"
	JMP	MSG_DISKSET99
MSG_DISKSET6:
	CMP	SCH_DISKID,MY_DISKNUMD7	; このデータディスク７
	JNE	MSG_DISKSET7
	PRINTM	"ドライブ２にディスクＧをいれて下さい"
	JMP	MSG_DISKSET99
MSG_DISKSET7:
MSG_DISKSET99:
	RET
MSG_DISKSET	ENDP



;	ドライブにセットされるのを待つ
;	-I- SCH_DISKID : 検索ディスクＩＤ
;	-O- DRVNUM     : ドライブ番号（０ー３）

INSDRIVE_WAIT	PROC	NEAR
	MOV	AX,DRVNUMMAX	; １ＭＦＤドライブ数
	MOV	DRVNUM,AX	; ドライブ番号（０ー３）

INSDRIVE_WAIT_LOOP:
	CMP	DRVNUM,0	; if DRVNUM = 0 then DRVNUM=DRVNUMMAX
	JNE	INSDRIVE_WAIT4	;
	MOV	AX,DRVNUMMAX	; １ＭＦＤドライブ数
	MOV	DRVNUM,AX	; ドライブ番号（０ー３）
INSDRIVE_WAIT4:
	DEC	DRVNUM		; ドライブ番号（０ー３）

	MOV	AX,DRVNUM	;
	CALL	RAM_DR_EQUIP	; ＲＡＭドライブ接続チェック

	MOV	AX,DRVNUM	;
	CALL	FDDOOR		; ＦＤドライブドア開閉チェック
	CMP	AX,1		; 0=前と変わらず,1=ドアを開閉した
				; 2=ドアが開きっぱなし
	JE	INSDRIVE_WAIT_CHK

INSDRIVE_WAIT_NEXT:
	JMP	INSDRIVE_WAIT_LOOP

INSDRIVE_WAIT_CHK:
	CALL	DSKIDCHK		; ディスクＩＤの読みだし
	CMP	AX,1			; 0=通常
	JE	INSDRIVE_WAIT_NEXT	; 1=ディスクはセットされていない
	CMP	AX,2			;
	JNE	INSDRIVE_WAIT_6		; 2=違うディスクみたい

	CMP	FLAG_RAM_DR,1		; RAMドライブ接続 1=接続されている
	JE	INSDRIVE_WAIT_NEXT	;
	PRINTM	"このディスクは関係ないよ！"
	CALL	MSG_DISKSET		; ディスクセットのメッセージ

	JMP	INSDRIVE_WAIT_NEXT	;
INSDRIVE_WAIT_6:
	CALL	IDGET			; ＩＤを汎用変数へセット

	MOV	AX,ID_DISKSYSNAME	; システムＩＤ
	CMP	AX,MY_DISKSYSNAME	; このシステムＩＤ
	JE	INSDRIVE_WAIT_SYS_OK	;

	CMP	FLAG_RAM_DR,1		; RAMドライブ接続 1=接続されている
	JE	INSDRIVE_WAIT_NEXT	;
	PRINTM	"これはちがうソフトのディスクですね"
	CALL	MSG_DISKSET		; ディスクセットのメッセージ

	JMP	INSDRIVE_WAIT_NEXT	;
INSDRIVE_WAIT_SYS_OK:			;
	MOV	AX,ID_DISKPROG		; プログラムＩＤ
	CMP	AX,MY_DISKPROG		; このプログラムＩＤ
	JE	INSDRIVE_WAIT_PROG_OK	;

	CMP	FLAG_RAM_DR,1		; RAMドライブ接続 1=接続されている
	JE	INSDRIVE_WAIT_NEXT	;
	PRINTM	"これはちがうソフトのプログラムですね"
	CALL	MSG_DISKSET		; ディスクセットのメッセージ

	JMP	INSDRIVE_WAIT_NEXT	;
INSDRIVE_WAIT_PROG_OK:			;
	MOV	AX,ID_DISKNUMBER	; ディスク番号
	CMP	AX,SCH_DISKID		; 検索ディスクＩＤ
	JE	INSDRIVE_WAIT_DISK_OK	;

	CMP	FLAG_RAM_DR,1		; RAMドライブ接続 1=接続されている
	JE	INSDRIVE_WAIT_NEXT	;
	PRINTM	"このディスクではないですよ"
	CALL	MSG_DISKSET		; ディスクセットのメッセージ

	JMP	INSDRIVE_WAIT_NEXT
INSDRIVE_WAIT_DISK_OK:
;*NON*;	PRINTM	"ディスクを確認しました"

	RET
INSDRIVE_WAIT	ENDP



;	対象ディスクのドライブ検索
;	-I- SCH_DISKID : 検索ディスクＩＤ
;	-O- AX : 0=対象ディスクはセットされています
;	         1=対象ディスクが挿入されていません
;	         2=
;	         3=
;	    DRVNUM : 対象ディスクのドライブ番号

SYSDRVCHK	PROC	NEAR
	PRV	"検索ディスクＩＤ=",SCH_DISKID

	MOV	AX,DRVNUMMAX	; １ＭＦＤドライブ数
	MOV	DRVNUM,AX	; ドライブ番号（０ー３）
SYSDRVCHK_LOOP:
	CMP	DRVNUM,0	; １ＭＦＤドライブ番号（０ー３）
	JNE	SYSDRVCHK2	;
	JMP	SYSDRVCHK_NONE	; 見つからなかった
SYSDRVCHK2:
	DEC	DRVNUM		;
	CALL	DSKIDCHK	; ディスクＩＤの読みだし
	CMP	AX,0		; 0=通常
	JNE	SYSDRVCHK_NEXT	; 1=ディスクはセットされていない
				; 2=違うディスクみたい

	CALL	IDGET		; ＩＤを汎用変数へセット

	MOV	AX,ID_DISKSYSNAME ; システムＩＤ
	CMP	AX,MY_DISKSYSNAME ; このシステムＩＤ
	JNE	SYSDRVCHK_NEXT	;
	MOV	AX,ID_DISKPROG	; プログラムＩＤ
	CMP	AX,MY_DISKPROG	; このプログラムＩＤ
	JNE	SYSDRVCHK_NEXT	;
	MOV	AX,ID_DISKNUMBER; ディスク番号
	CMP	AX,SCH_DISKID	; 検索ディスクＩＤ
	JNE	SYSDRVCHK_NEXT	;

	JMP	SYSDRVCHK_OK	; このディスクが対象ディスクです
SYSDRVCHK_NEXT:
	JMP	SYSDRVCHK_LOOP	;

SYSDRVCHK_OK:
	MOV	AX,0	; 0=対象ディスクはセットされています
	JMP	SYSDRVCHK_RET
SYSDRVCHK_NONE:
	MOV	AX,1	; 1=対象ディスクが挿入されていません
	JMP	SYSDRVCHK_RET
SYSDRVCHK_RET:
	PRV	"対象ディスクは？0=セット,1=セットしていない AX=",AX
	RET
SYSDRVCHK	ENDP



;	ＩＤテーブルの内容を汎用変数へセット
;	-I- DRVNUM : １ＭＦＤドライブ番号（０ー３）
;	    ID_DISKSYSNAME : システムＩＤ
;	    ID_DISKPROG    : プログラムＩＤ
;	    ID_DISKNUMBER  : ディスク番号

IDGET	PROC	NEAR
	PRV	"１ＭＦＤドライブ番号=",DRVNUM

	MOV	BX,DRVNUM		; ドライブ番号
	SHL	BX,1			; word pointer.
	MOV	SI,DS:DSKID_ADRS[BX]	; ディスクＩＤアドレステーブル
	MOV	AX,DS:[SI][0]		;
	MOV	ID_DISKSYSNAME,AX	; システムＩＤ
	MOV	AX,DS:[SI][2]		;
	MOV	ID_DISKPROG,AX		; プログラムＩＤ
	MOV	AX,DS:[SI][4]		;
	MOV	ID_DISKNUMBER,AX	; ディスク番号

	PRVH	"システムＩＤ  =",ID_DISKSYSNAME
	PRVH	"プログラムＩＤ=",ID_DISKPROG
	PRV	"ディスク番号  =",ID_DISKNUMBER

	RET
IDGET	ENDP



;*;;	汎用変数の内容をＩＤテーブルへセット
;*;;	-I- DRVNUM : １ＭＦＤドライブ番号（０ー３）
;*;;	    ID_DISKSYSNAME : システムＩＤ
;*;;	    ID_DISKPROG    : プログラムＩＤ
;*;;	    ID_DISKNUMBER  : ディスク番号
;*;
;*;IDPUT	PROC	NEAR
;*;	PRV	"１ＭＦＤドライブ番号=",DRVNUM
;*;	PRVH	"システムＩＤ  =",ID_DISKSYSNAME
;*;	PRVH	"プログラムＩＤ=",ID_DISKPROG
;*;	PRV	"ディスク番号  =",ID_DISKNUMBER
;*;
;*;	MOV	BX,DRVNUM	; ドライブ番号
;*;	SHL	BX,1		; word pointer.
;*;	MOV	SI,DS:DSKID_ADRS[BX]	; ディスクＩＤアドレステーブル
;*;	MOV	AX,ID_DISKSYSNAME	; システムＩＤ
;*;	MOV	DS:[SI][0],AX		;
;*;	MOV	AX,ID_DISKPROG		; プログラムＩＤ
;*;	MOV	DS:[SI][2],AX		;
;*;	MOV	AX,ID_DISKNUMBER	; ディスク番号
;*;	MOV	DS:[SI][4],AX		;
;*;	RET
;*;IDPUT	ENDP



;	ディスクＩＤの読みだし
;	-I- DRVNUM : １ＭＦＤドライブ番号（０ー３）
;	-O- DSKID_ADRS[AX*2] : ＩＤテーブル
;	    DSKID0 : ドライブ０のＩＤテーブル
;	    DSKID1 : ドライブ１のＩＤテーブル
;	    DSKID2 : ドライブ２のＩＤテーブル
;	    DSKID3 : ドライブ３のＩＤテーブル
;	    AX     : 0=通常
;	           : 1=ディスクはセットされていない
;	           : 2=違うディスクみたい
;	-I/O- DATA:[+SCADRS] : セクタのデータ

DSKIDCHK	PROC	NEAR
	PRV	"ディスクＩＤの読みだし:１ＭＦＤドライブ番号=",DRVNUM

	MOV	AX,DRVNUM	;
	CALL	FDDOOR		; ＦＤドライブドア開閉チェック
	CMP	AX,0		; 0=前と変わらず,1=ドアを開閉した
	JE	DSKIDCHK_OK	;
	CMP	AX,2		; 2=ドアが開きっぱなし
	JE	DSKIDCHK_NOT_RDY

	MOV	AX,DRVNUM	;
	CALL	READIDSEC	; ＩＤセクタの読みだし
	CMP	AX,1		; 1=リードエラー
	JE	DSKIDCHK_ERROR	;
	CMP	AX,2		; 2=ノットレディ
	JE	DSKIDCHK_NOT_RDY;
DSKIDCHK_OK:
	MOV	AX,0		; 0=通常
	RET
DSKIDCHK_NOT_RDY:
	MOV	AX,1		; 1=ディスクはセットされていない
	RET
DSKIDCHK_ERROR:
	MOV	AX,2		; 2=違うディスクみたい
	RET
DSKIDCHK	ENDP



;	ＩＤセクタの読みだし
;	-I- AX : １ＭＦＤドライブ番号（０ー３）
;	-O- DSKID_ADRS[AX*2] : ＩＤテーブル
;	    DSKID0 : ドライブ０のＩＤテーブル
;	    DSKID1 : ドライブ１のＩＤテーブル
;	    DSKID2 : ドライブ２のＩＤテーブル
;	    DSKID3 : ドライブ３のＩＤテーブル
;	    AX     : 0=正常,1=リードエラー,2=ノットレディ
;	-I/O- DATA:[+SCADRS] : セクタのデータ

READIDSEC	PROC	NEAR
	CALL	DRVSET		; ドライブ番号の設定（０ー３）

	MOV	AX,DCYL_ID	; ディスクＩＤ　シリンダ番号
	MOV	DCYL,AX		; シリンダ番号（Ｃ）０ー７６
	MOV	AX,DHEAD_ID	; ディスクＩＤ　ヘッド番号
	MOV	DHEAD,AX	; ヘッド番号（Ｈ）０ー１
	MOV	AX,DSECR_ID	; ディスクＩＤ　セクタ番号
	MOV	DSECR,AX	; セクタ番号（Ｒ）１ー８（２６）

	CALL	SCREAD		; セクターリード
	PRV	"READIDSEC call-O-scread DERROR=",DERROR
	CMP	DERROR,0	; 0=正常,1=エラー
	JNE	READIDSEC_ERROR	;

	CALL	DRVNO		; ドライブ番号の取得
	MOV	BX,AX		;
	SHL	BX,1		; word pointer.
	MOV	DI,DS:DSKID_ADRS[BX] ; ディスクＩＤアドレステーブル
	MOV	AX,DS		;
	MOV	ES,AX		;
	MOV	SI,SCADRS	; セクタバッファアドレス
	MOV	CX,ID_LEN	; ディスクＩＤバイト数
	REP	MOVSB		;

	MOV	AX,0		; 0=正常
	RET
READIDSEC_ERROR:
	CMP	DSTAT,DISK_STATUS_NR	; Not Ready. ユニットがノットレディ状態
	JE	READIDSEC_ERROR2	;
	MOV	AX,1			; 1=リードエラー
	RET
READIDSEC_ERROR2:
	MOV	AX,2			; 2=ノットレディ
	RET
READIDSEC	ENDP


;*NON*;
;*NON*;;	ディスクＩＤの書き込み
;*NON*;;	-I- DRVNUM : １ＭＦＤドライブ番号（０−３）
;*NON*;;	    DSKID_ADRS[AX*2] : ＩＤテーブル
;*NON*;;	    DSKID0 : ドライブ０のＩＤテーブル
;*NON*;;	    DSKID1 : ドライブ１のＩＤテーブル
;*NON*;;	    DSKID2 : ドライブ２のＩＤテーブル
;*NON*;;	    DSKID3 : ドライブ３のＩＤテーブル
;*NON*;;	-O- AX     : 0=通常
;*NON*;;	           : 1=ディスクはセットされていない
;*NON*;;	           : 2=違うディスクみたい
;*NON*;;	-I/O- DATA:[+SCADRS] : セクタのデータ
;*NON*;
;*NON*;DSKIDSET	PROC	NEAR
;*NON*;	PRV	"ディスクＩＤの書き込み:１ＭＦＤドライブ番号=",DRVNUM
;*NON*;
;*NON*;	MOV	AX,DRVNUM	;
;*NON*;	CALL	FDDOOR		; ＦＤドライブドア開閉チェック
;*NON*;	CMP	AX,2		; 2=ドアが開きっぱなし
;*NON*;	JE	DSKIDSET_NOT_RDY
;*NON*;
;*NON*;	MOV	AX,DRVNUM	;
;*NON*;	CALL	WRITEIDSEC	; ＩＤセクタの書き込み
;*NON*;	CMP	AX,0		; 0=正常,1=リードエラー
;*NON*;	JNE	DSKIDSET_ERROR	;
;*NON*;DSKIDSET_OK:
;*NON*;	MOV	AX,0		; 0=通常
;*NON*;	RET
;*NON*;DSKIDSET_NOT_RDY:
;*NON*;	MOV	AX,1		; 1=ディスクはセットされていない
;*NON*;	RET
;*NON*;DSKIDSET_ERROR:
;*NON*;	MOV	AX,2		; 2=違うディスクみたい
;*NON*;	RET
;*NON*;DSKIDSET	ENDP
;*NON*;


;	ＩＤセクタの書き込み
;	-I- AX : １ＭＦＤドライブ番号（０ー３）
;	    DSKID_ADRS[AX*2] : ＩＤテーブル
;	    DSKID0 : ドライブ０のＩＤテーブル
;	    DSKID1 : ドライブ１のＩＤテーブル
;	    DSKID2 : ドライブ２のＩＤテーブル
;	    DSKID3 : ドライブ３のＩＤテーブル
;	-O- AX     : 0=正常,1=ライトエラー,2=ノットレディ
;	-I/O- DATA:[+SCADRS] : セクタのデータ

WRITEIDSEC	PROC	NEAR
	CALL	DRVSET		; ドライブ番号の設定（０ー３）

	MOV	BX,AX		;
	SHL	BX,1		; word pointer.
	MOV	SI,DS:DSKID_ADRS[BX] ; ディスクＩＤアドレステーブル
	MOV	AX,DS		;
	MOV	ES,AX		;
	MOV	DI,SCADRS	; セクタのデータ
	MOV	CX,ID_LEN	; ディスクＩＤバイト数
	REP	MOVSB		;

	MOV	AX,DCYL_ID	; ディスクＩＤ　シリンダ番号
	MOV	DCYL,AX		; シリンダ番号（Ｃ）０ー７６
	MOV	AX,DHEAD_ID	; ディスクＩＤ　ヘッド番号
	MOV	DHEAD,AX	; ヘッド番号（Ｈ）０ー１
	MOV	AX,DSECR_ID	; ディスクＩＤ　セクタ番号
	MOV	DSECR,AX	; セクタ番号（Ｒ）１ー８（２６）

	CALL	SCWRITE		; セクターリード
	CMP	DERROR,0	; 0=正常,1=エラー
	JNE	WRITEIDSEC_ERROR

	MOV	AX,0		; 0=正常
	RET
WRITEIDSEC_ERROR:
	CMP	DSTAT,DISK_STATUS_NR	; Not Ready. ユニットがノットレディ状態
	JE	WRITEIDSEC_ERROR2	;
	MOV	AX,1			; 1=ライトエラー
	RET
WRITEIDSEC_ERROR2:
	MOV	AX,2			; 2=ノットレディ
	RET
WRITEIDSEC	ENDP





;	セクターリード
;	バウンダリングエラーの為、ＳＣＡＤＲＳが変更される場合がある
;	-I- DCYL  : シリンダ番号（Ｃ）０ー７６
;	    DHEAD : ヘッド番号（Ｈ）０ー１
;	    DSECR : セクタ番号（Ｒ）１ー８（２６）
;	-O- SCADRS : セクタバッファアドレス
;	    DATA:[+SCADRS] : セクタのデータ
;	    DERROR : 0=正常,1=エラー
;	    DSTAT  : ステータス情報

SCREAD	PROC	NEAR
	CALL	DOSCALLX	; ＤＯＳへアクセスさせておく

	PRVH	"r DUNIT ",DUNIT; デバイス識別・ユニット番号(DA/UA)
	PRVH	"r DLEN  ",DLEN	; データ長（ＤＴＬ）（バイト単位）
	PRVH	"r DCYL  ",DCYL ; シリンダ番号（Ｃ）０ー７６
	PRVH	"r DHEAD ",DHEAD; ヘッド番号（Ｈ）０ー１
	PRVH	"r DSECR ",DSECR; セクタ番号（Ｒ）１ー８（２６）
	PRVH	"r DSECN ",DSECN; セクタ長（Ｎ）

	MOV	AX,READ_RETCOUNT; リード・リトライカウンタ
	MOV	READ_RETRY,AX	;

SCREAD5:
	MOV	AX,SEG DATA	; セクタバッファ
	MOV	ES,AX		;
	MOV	BP,SCADRS	; セクタバッファアドレス

	MOV	AL,BYTE PTR DUNIT ; デバイス識別・ユニット番号(DA/UA)
	MOV	BX,WORD PTR DLEN  ; データ長（ＤＴＬ）（バイト単位）
	MOV	CL,BYTE PTR DCYL  ; シリンダ番号（Ｃ）０ー７６
	MOV	DH,BYTE PTR DHEAD ; ヘッド番号（Ｈ）０ー１
	MOV	DL,BYTE PTR DSECR ; セクタ番号（Ｒ）１ー８（２６）
	MOV	CH,BYTE PTR DSECN ; セクタ長（Ｎ）
	MOV	AH,BYTE PTR DREAD ; ＲＥＡＤ　ＤＡＴＡ
	INT_FD_BIOS		  ; disk/FD bios.
	MOV	BYTE PTR DSTAT,AH ; ステータス情報

	JNB	SCREAD9		  ; 正常終了

	CMP	BYTE PTR DSTAT,DISK_STATUS_DB
				; DMA Boundary.メモリアドレスがＤＭＡ
				; に向いていない（バンクにまたがった）
	JNE	SCREAD6
	PRF	"致命的なエラー( READ SECTOR:error DB )"
	PRINTM	"DMA Boundary error.によりバッファ切替"
	MOV	AX,TIME_DKCMSG		; メッセージ時間
	CALL	TMVWT4			; V-SYNC timer4 wait.

	MOV	SCADRS,OFFSET SCDATA2	; セクタバッファアドレス
	JMP	SCREAD5			; ＤＭＡバッファの変更


SCREAD6:
	DEC	READ_RETRY	  ; リード・リトライカウンタ
	JZ	SCREAD99

	MOV	AH,BYTE PTR DRECAL ; ＲＥＣＡＬＩＢＲＡＴＥ
	INT_FD_BIOS		   ; disk/FD bios.
	MOV	BYTE PTR DSTAT,AH  ; ステータス情報
	PRVH	"R recalibrate DSTAT=",DSTAT

	JMP	SCREAD5
SCREAD9:
	MOV	DERROR,0	; 0=正常
	RET
SCREAD99:
	MOV	DERROR,1	; 1=エラー
	MOV	AX,2
;*NON*;	CALL	SCERROR		; ディスクＩ／Ｏエラーの通知
	RET
SCREAD	ENDP



;	セクター書き込み
;	バウンダリングエラーの為、ＳＣＡＤＲＳが変更される場合がある
;	-I- DATA:[+SCADRS] : セクタのデータ
;	    DCYL          : シリンダ番号（Ｃ）０ー７６
;	    DHEAD         : ヘッド番号（Ｈ）０ー１
;	    DSECR         : セクタ番号（Ｒ）１ー２６
;	-O- SCADRS        : セクタバッファアドレス
;	    DERROR        : 0=正常,1=エラー
;	    DSTAT         : ステータス情報

SCWRITE	PROC	NEAR
	CALL	DOSCALLX	; ＤＯＳへアクセスさせておく

SCWRITE0:
	MOV	AH,BYTE PTR DSENSE ; ＳＥＮＳＥ
	MOV	AL,BYTE PTR DUNIT ; デバイス識別・ユニット番号(DA/UA)
	INT_FD_BIOS		  ; disk/FD bios.
	MOV	BYTE PTR DSTAT,AH ; ステータス情報
	TEST	AH,10H		; 1=ライトプロテクトが付いている
	JZ	SCWRITE01	;
	JMP	SCWRITE99	; エラー
SCWRITE01:
	PRVH	"w DUNIT ",DUNIT; デバイス識別・ユニット番号(DA/UA)
	PRVH	"w DLEN  ",DLEN ; データ長（ＤＴＬ）（バイト単位）
	PRVH	"w DCYL  ",DCYL ; シリンダ番号（Ｃ）０ー７６
	PRVH	"w DHEAD ",DHEAD; ヘッド番号（Ｈ）０ー１
	PRVH	"w DSECR ",DSECR; セクタ番号（Ｒ）１ー８（２６）
	PRVH	"w DSECN ",DSECN; セクタ長（Ｎ）

	MOV	AX,WRITE_RETCOUNT; セクタ書き込み・リトライ回数
	MOV	WRITE_RETRY,AX	 ; セクタ書き込み・リトライカウンタ
SCWRITE1:
	MOV	AX,SEG DATA	 ; ＤＭＡバッファセグメント
	MOV	ES,AX		 ;
	MOV	BP,SCADRS	 ; セクタバッファアドレス

	MOV	AL,BYTE PTR DUNIT ; デバイス識別・ユニット番号(DA/UA)
	MOV	BX,WORD PTR DLEN  ; データ長（ＤＴＬ）（バイト単位）
	MOV	CL,BYTE PTR DCYL  ; シリンダ番号（Ｃ）０ー７６
	MOV	DH,BYTE PTR DHEAD ; ヘッド番号（Ｈ）０ー１
	MOV	DL,BYTE PTR DSECR ; セクタ番号（Ｒ）１ー２６
	MOV	CH,BYTE PTR DSECN ; セクタ長（Ｎ）　

	MOV	AH,BYTE PTR DWRITE; ＷＲＩＴＥＤＡＴＡ
	INT_FD_BIOS		  ; disk/FD bios.
	MOV	BYTE PTR DSTAT,AH ; ステータス情報

	JNB	SCWRITE9	; 正常終了

	CMP	BYTE PTR DSTAT,DISK_STATUS_DB
				; DMA Boundary.メモリアドレスがＤＭＡ
				; に向いていない（バンクにまたがった）
	JNE	SCWRITE5

	PRF	"致命的なエラー( WRITE SECTOR:error DB )"

	PUSH	AX
	PUSH	CX
	PUSH	ES
	PUSH	DI
	PUSH	SI
	MOV	AX,DS
	MOV	ES,AX
	MOV	SI,OFFSET SCDATA
	MOV	DI,OFFSET SCDATA2
	MOV	CX,SEC_BYTE		; セクタバッファの長さ
	REP	MOVSB
	POP	SI
	POP	DI
	POP	ES
	POP	CX
	POP	AX

	MOV	SCADRS,OFFSET SCDATA2	; セクタバッファアドレス
	JMP	SCWRITE1		; ＤＭＡバッファの変更

SCWRITE5:
	DEC	WRITE_RETRY	; セクタ書き込み・リトライカウンタ
	JZ	SCWRITE99

	MOV	AH,BYTE PTR DRECAL ; ＲＥＣＡＬＩＢＲＡＴＥ
	INT_FD_BIOS		   ; disk/FD bios.
	MOV	BYTE PTR DSTAT,AH  ; ステータス情報

	JMP	SCWRITE1	;
SCWRITE9:
	MOV	DERROR,0	; 0=正常
	RET
SCWRITE99:
	MOV	DERROR,1	; 1=エラー
	RET
SCWRITE	ENDP


;*NON*;
;*NON*;
;*NON*;;	ディスクＩ／Ｏエラーの通知
;*NON*;;	-I- AX : 1=シーク中のエラー
;*NON*;;		 2=読み込み中のエラー
;*NON*;;		 3=書き込み中のエラー
;*NON*;;		 4=ファイルが見つからない
;*NON*;
;*NON*;SCERROR	PROC	NEAR
;*NON*;	CMP	AX,1
;*NON*;	JE	SCERROR1
;*NON*;	CMP	AX,2
;*NON*;	JE	SCERROR2
;*NON*;	CMP	AX,3
;*NON*;	JE	SCERROR3
;*NON*;	CMP	AX,4
;*NON*;	JE	SCERROR4
;*NON*;
;*NON*;	MOV	SI,OFFSET MSGER0
;*NON*;	CALL	PRINT
;*NON*;	RET
;*NON*;SCERROR1:
;*NON*;	MOV	SI,OFFSET MSGER1
;*NON*;	CALL	PRINT
;*NON*;	RET
;*NON*;SCERROR2:
;*NON*;	MOV	SI,OFFSET MSGER2
;*NON*;	CALL	PRINT
;*NON*;	RET
;*NON*;SCERROR3:
;*NON*;	MOV	SI,OFFSET MSGER3
;*NON*;	CALL	PRINT
;*NON*;	RET
;*NON*;SCERROR4:
;*NON*;	MOV	SI,OFFSET MSGER4
;*NON*;	CALL	PRINT
;*NON*;	RET
;*NON*;SCERROR	ENDP
;*NON*;
;*NON*;

;	ＤＯＳへアクセスさせておく
;	-I- DOSSTP : 0=通常,1=標準ＤＯＳのアクセスを止めます

DOSCALLX	PROC	NEAR
	CMP	DOSSTP,1	; 0=通常,1=標準ＤＯＳのアクセスを止めます
	JE	DOSCALLX9	;

	CALL	DRVNO		; ドライブ番号の取得
	MOV	BX,AX		; １ＭＦＤドライブ番号
	MOV	AL,DS:DRIVENAME_TBL[BX]	; ドライブ名テーブル 0=A,1=B,2=C,3=D
	ADD	AL,DRIVENAME_SFT	; ドライブ名と2HDユニット番号のズレ
	MOV	DOSCALLX_DUMMY,AL ; "A:XXXXYYYYAAA",0 : ＤＯＳアクセス用ダミー

	MOV	SI,OFFSET DOSCALLX_DUMMY
	CALL	DSKOPNT		; DOS file open.ドライブ検索無しﾌｧｲﾙｵｰﾌﾟﾝ
	CMP	AX,0		;
	JNE	DOSCALLX9	;

	CALL	DSKCLS		; DOS file close.
DOSCALLX9:			;
	RET
DOSCALLX	ENDP



;	ＦＤドライブドア開閉チェック
;	-I- AX : １ＭＦＤドライブ番号（０ー３）
;	-O- AX : 0=前と変わらず,1=ドアを開閉した,2=ドアが開きっぱなし

FDDOOR	PROC	NEAR
	PUSH	DX
	PUSH	BX
	PUSH	ES

	PUSH	AX		; １ＭＦＤドライブ番号（０ー３）
	CALL	FDEQUIP		; ＦＤ接続チェック
	CMP	AX,0		; 1=接続されている,0=接続無し
	POP	AX		;
	JE	FDDOOR_NO_SET	;

	PUSH	AX	;
	CALL	FDRSLT	; ＦＤドライブドア開閉チェック(ﾘｻﾞﾙﾄｽﾃｰﾀｽﾁｪｯｸ)
	POP	BX	; BX=drive number.
	CMP	AX,1	; 1=ドアを開閉した
	JE	FDDOOR_SET
	CMP	AX,0	; 0=前と変わらず, 2=ドアが開きっぱなし
	JE	FDDOOR_NORMAL

FDDOOR_RETRY:
	; リザルトステータス・テーブルに反映されない
	; 場合に対してもＢＩＯＳでチェックする

	MOV	AL,BL			; AX=ドライブ番号
					; 90Hは１ＭＦＤであることを示す
	OR	AL,90H			; AL=デバイス識別・ユニット番号(DA/UA)
;*NON*;	MOV	AH,BYTE PTR DSENSE	; ＳＥＮＳＥ
	MOV	AH,BYTE PTR DSENSE_NEW	; ＳＥＮＳＥ（／ＳＴＡＴＵＳ）
	INT_FD_BIOS		        ; disk/FD bios.

	JB	FDDOOR_NO_SET		; CF=1 異常終了

	TEST	AH,60H			; 60H=ＮＲ／媒体がセットされていない
	JNZ	FDDOOR_NO_SET		;
FDDOOR_SET:
	CALL	USER_STANBY		; ユーザから直接、スタンバイが出た
	MOV	AX,1			; 1=ドアを開閉した
	JMP	FDDOOR9			;
FDDOOR_NO_SET:
	CALL	DRVTIMER		; ディスク装置監視タイマ
	CALL	USER_STANBY		; ユーザから直接、スタンバイが出た
	MOV	AX,2			; 2=ドアが開きっぱなし
	JMP	FDDOOR9			;
FDDOOR_NORMAL:
	CALL	USER_STANBY		; ユーザから直接、スタンバイが出た
	CMP	BX,1			; 1=スタンバイ
	JNE	FDDOOR_NORMAL2		;
	MOV	AX,1			; 1=ドアを開閉した
	JMP	FDDOOR9			;
FDDOOR_NORMAL2:
	MOV	AX,0			; 0=前と変わらず
FDDOOR9:
	PRV	"FDDOOR -o- (0n,1oc,2o)=",AX
	POP	ES
	POP	BX
	POP	DX
	RET
FDDOOR	ENDP



;	ＦＤドライブドア開閉チェック（リザルトステータスチェック）
;	-I- AX : １ＭＦＤドライブ番号（０ー３）
;	-O- AX : 0=前と変わらず,1=ドアを開閉した,2=ドアが開きっぱなし

FDRSLT	PROC	NEAR
	PUSH	DX
	PUSH	BX
	PUSH	ES

	MOV	DX,AX		; DX=ドライブ番号

	MOV	BX,AX
	SHL	BX,1	; *2
	SHL	BX,1	; *4
	SHL	BX,1	; *8
	ADD	BX,DISK_RESULT_TOP ; リザルトステータス情報アドレス
	MOV	AX,0			;
	MOV	ES,AX			;
	MOV	AL,BYTE PTR ES:[BX]	; disk result status ST0.
;		  |iiSenHuu|
;		  |ccEcrDss|
;		  |10    10|
	AND	AL,11001000B

	CMP	AL,0
	JNE	FDRSLT5		;
	MOV	AX,0		; 0=前と変わらず
	JMP	FDRSLT9		;
FDRSLT5:
	CMP	AL,11000000B	;
	JNE	FDRSLT6		;
	MOV	AX,1		; 1=ドアを開閉した
	JMP	FDRSLT9
FDRSLT6:
	CMP	AL,11001000B	;
	JNE	FDRSLT7		;
	MOV	AX,2		; 2=ドアが開きっぱなし
	JMP	FDRSLT9
FDRSLT7:
	MOV	AX,2		; 2=ドアが開きっぱなし

FDRSLT9:
	MOV	BX,DX		; DX=ドライブ番号
	CMP	BYTE PTR DS:DISK_DOOR_INI[BX],0	; ディスク開閉初期ﾌﾗｸﾞ
	JZ	FDRSLT_RET

	MOV	BYTE PTR DS:DISK_DOOR_INI[BX],0	; ディスク開閉初期ﾌﾗｸﾞ
	CMP	AX,0		; 0=前と変わらず
	JNE	FDRSLT_RET	;
	MOV	AX,1		; 1=ドアを開閉した
FDRSLT_RET:
	POP	ES
	POP	BX
	POP	DX
	RET
FDRSLT	ENDP


;	ＦＤ接続チェック
;	-I- AX : １ＭＦＤドライブ番号（０ー３）
;	-O- AX : 1=接続されている,0=接続無し

FDEQUIP	PROC	NEAR
	PUSH	CX
	PUSH	DX

	MOV	DX,0			; 接続チェック
	MOV	ES,DX			;
	MOV	CL,AL			; １ＭＦＤドライブ番号（０ー３）
	MOV	DL,1			;
	SHL	DL,CL			; ビットＯＮならば接続
	TEST	ES:[DISK_EQUIP],DL	; 接続ユニット
	JNZ	FDEQUIP_ON		;
FDEQUIP_OFF:
	MOV	AX,0			; 0=接続無し
	POP	DX
	POP	CX
	RET
FDEQUIP_ON:
	MOV	AX,1			; 1=接続されている
	POP	DX
	POP	CX
	RET
FDEQUIP	ENDP


;	ＲＡＭドライブ接続チェック
;	-I- AX          : １ＭＦＤドライブ番号（０ー３）
;	-O- FLAG_RAM_DR : RAMドライブ接続 1=接続されている,0=接続無し

RAM_DR_EQUIP	PROC	NEAR
	MOV	DX,0			; 接続チェック
	MOV	ES,DX			;
	MOV	CL,AL			; １ＭＦＤドライブ番号（０ー３）
	MOV	DL,1			;
	SHL	DL,CL			; ビットＯＮならば接続

	TEST	ES:[DISK_EQUIP],DL	; 接続ユニット
	JZ	RAM_DR_EQUIP_OFF	;
	TEST	ES:[RDISK_EQUIP],DL	; ＲＡＭドライブ接続状況識別ビット
	JZ	RAM_DR_EQUIP_OFF	;
	JMP	RAM_DR_EQUIP_ON		;
RAM_DR_EQUIP_OFF:
	MOV	FLAG_RAM_DR,0		; 0=接続無し
	RET
RAM_DR_EQUIP_ON:
	MOV	FLAG_RAM_DR,1		; 1=接続されている
	RET
RAM_DR_EQUIP	ENDP


;	ドライブ番号の設定（０ー３）
;	-I- AX : １ＭＦＤドライブ番号

DRVSET	PROC	NEAR
	PUSH	AX
	AND	AL,011B
	AND	BYTE PTR DUNIT,11111100B
	OR	BYTE PTR DUNIT,AL
	POP	AX
	RET
DRVSET	ENDP



;	ドライブ番号の取得
;	-O- AX : １ＭＦＤドライブ番号

DRVNO	PROC	NEAR
	MOV	AX,DUNIT	; デバイス識別・ユニット番号（DA/UA）
	AND	AX,00000011B	; DA/UA=100100dd

	PRV	"DUNITのドライブ番号=",AX
	RET
DRVNO	ENDP



;	ディスク装置監視タイマ

DRVTIMER	PROC	NEAR
	PUSH	AX
	PUSH	BX
WAIT_FDUNIT_TIMER	EQU	3	; ディスク監視用ＶＳＹＮＣｲﾝﾀｰﾊﾞﾙﾀｲﾏ値
	MOV	AX,WAIT_FDUNIT_TIMER	; wait timer count.
	CALL	TMVWT4			; V-SYNC timer4 wait.
	POP	BX
	POP	AX
	RET
DRVTIMER	ENDP


;	ハンドル用パス名編集
;	-I- DRVNUM        : 指定ディスクのドライブ番号（−１はカレント）
;	    DIRNAME       : 対象ファイル名
;	-O- DIRHANDLEPATH : ハンドル用パス名 "A:12345678.123",0

KFLHANDLE	PROC	NEAR
	MOV	AX,DS			;
	MOV	ES,AX			;
	MOV	DI,OFFSET DIRHANDLEPATH	; ハンドル用パス名

	CMP	DRVNUM,-1		; ドライブ番号（−１はカレント）
	JE	KFLHANDLE_NAME		;

KFLHANDLE_DRIVE:			;
	MOV	BX,DRVNUM		; 指定ディスクのドライブ番号
	MOV	AL,DS:DRIVENAME_TBL[BX]	; ドライブ名テーブル 0=A,1=B,2=C,3=D
	ADD	AL,DRIVENAME_SFT	; ドライブ名と2HDユニット番号のズレ
	STOSB				; ドライブ名 "A","B","C","D"
	MOV	AL,':'			;
	STOSB				;

KFLHANDLE_NAME:				;
	MOV	SI,OFFSET DIRNAME	; 対象ファイル名
	MOV	CX,8			;
KFLHANDLE_LOOP1:			;
	LODSB				; 対象ファイル名
	CMP	AL,' '			; space.
	JBE	KFLHANDLE_NEXT1		;
	CMP	AL,'.'			; dot.
	JE	KFLHANDLE_DOT		;
	STOSB				; "A:12345678.123",0
KFLHANDLE_NEXT1:			;
	LOOP	KFLHANDLE_LOOP1		;

KFLHANDLE_DOT:				; ．
	MOV	AL,'.'			; dot.
	STOSB				; "A:12345678.123",0

KFLHANDLE_ATTR:				; 拡張子
	MOV	CX,3			;
KFLHANDLE_LOOP2:			;
	LODSB				; 対象ファイル名
	CMP	AL,' '			; space.
	JBE	KFLHANDLE_EOS		;
	STOSB				; "A:12345678.123",0
KFLHANDLE_NEXT2:			;
	LOOP	KFLHANDLE_LOOP2		;

KFLHANDLE_EOS:				; パス名の終り
	MOV	AL,0			; end of string.
	STOSB				; "A:12345678.123",0

	RET
KFLHANDLE	ENDP


;	指定ファイル名のカラム合わせ ex. "TEST.ASM"->"TEST____ASM"
;	-I- DS:SI  : ファイル名
;	-O- FLNAME : ファイル名

KFLNSET	PROC	NEAR
	PUSH	SI

	MOV	AX,SEG DATA
	MOV	ES,AX
	MOV	DI,OFFSET FLNAME
	MOV	CX,FLNLEN+FLTLEN
	MOV	AL,' '
	REP	STOSB

	MOV	DI,OFFSET FLNAME
	MOV	CX,FLNLEN+FLTLEN
KFLNSET2:
	LODSB
	CMP	AL,'.'		; next type.
	JE	KFLNSET4	;
	CMP	AL,20H		; end of string.
	JB	KFLNSET9	;
	STOSB			;
	LOOP	KFLNSET2	;
	JMP	KFLNSET9	;

KFLNSET4:
	MOV	DI,OFFSET FLTYPE
	MOV	CX,FLTLEN
KFLNSET5:
	LODSB
	CMP	AL,'.'		; next type.
	JE	KFLNSET9	;
	CMP	AL,20H		; end of string.
	JB	KFLNSET9	;
	STOSB			;
	LOOP	KFLNSET5	;

KFLNSET9:
	POP	SI
	RET
KFLNSET	ENDP


MSGX1	EQU	20
MSGY1	EQU	8
MSGX2	EQU	59
MSGY2	EQU	13
CHR_CR	EQU	0DH
CHR_LF	EQU	0AH

ATR_MSGBOX	EQU	10100101B
ATR_WID_NO	EQU	00000001B
ATR_WID_OP	EQU	00000001B ;11000101B


;	メッセージ出力
;	-I- DS:SI : メッセージ文字列

MSGPRN	PROC	NEAR
	PUSH	AX
	PUSH	BX
	PUSH	CX
	PUSH	DX
	PUSH	BP
	PUSH	DI
	PUSH	SI
	PUSH	ES


	CMP	XWINDOW_FLAG,1		; 1=外部ウインドウを使う
	JNE	MSGPRN1			;
	CALL	XWINDOW_START		; 外部ウインドウ表示
	JMP	MSGPRN9			;
MSGPRN1:				;


	CMP	MSGWIDFLG,0		; 1=メッセージ表示開始
	JNE	MSGPRN00		;

	CALL	CLS

	CALL	MSG_WINDOW_OPEN		; ウインドウオープン

	MOV	VX1,MSGX1-2		; source point x1.
	MOV	VY1,MSGY1-1		; source point y1.
	MOV	VX2,MSGX2+2		; length x2.
	MOV	VY2,MSGY2+1		; length y2.
	MOV	DX,ATR_MSGBOX		;
	PUSH	SI			;
	CALL	TXTBOX			; テキスト属性ＢＯＸセット
	POP	SI			;

	PUSH	SI			;
	MOV	AX,MSGX1		;
	MOV	BX,MSGY2-2		;
	CALL	LOCATE			; locate.
	MOV	SI,OFFSET MSG_SYSNAME1	; system name.
	CALL	PRINT			;
	MOV	AX,MSGX1		;
	MOV	BX,MSGY2-1		;
	CALL	LOCATE			; locate.
	MOV	SI,OFFSET MSG_SYSNAME2	; system name.
	CALL	PRINT			;
	MOV	AX,MSGX1		;
	MOV	BX,MSGY2		;
	CALL	LOCATE			; locate.
	MOV	SI,OFFSET MSG_SYSNAME3	; system name.
	CALL	PRINT			;
	POP	SI			;

MSGPRN00:
	MOV	AX,0			;
	MOV	BX,24			;
	CALL	LOCATE			; locate.
	MOV	AL,CHR_CR		;
	CALL	CHPUT			;
	MOV	AL,CHR_LF		; roll up.
	CALL	CHPUT			;

	MOV	AX,MSGX1		;
	MOV	BX,MSGY1-1		;
	CALL	LOCATE			; locate.
	MOV	CX,MSGX2-MSGX1+1	;
MSGPRN01:
	MOV	AL,' '			; space clear.
	CALL	CHPUT			;
	LOOP	MSGPRN01

	MOV	CHRPNT,MSGX1		; キャラクタポインタ
	MOV	AX,CHRPNT		;
	MOV	BX,MSGY2		;
	CALL	LOCATE			; locate.
MSGPRN2:
	CMP	CHRPNT,MSGX2		;
	JBE	MSGPRN5			;

	MOV	AX,0			;
	MOV	BX,24			;
	CALL	LOCATE			; locate.
	MOV	AL,CHR_CR		;
	CALL	CHPUT			;
	MOV	AL,CHR_LF		; roll up.
	CALL	CHPUT			;

	MOV	AX,MSGX1		;
	MOV	BX,MSGY1-1		;
	CALL	LOCATE			; locate.
	MOV	CX,MSGX2-MSGX1+1	;
MSGPRN02:
	MOV	AL,' '			; space clear.
	CALL	CHPUT			;
	LOOP	MSGPRN02		;

	MOV	CHRPNT,MSGX1		; キャラクタポインタ
	MOV	AX,CHRPNT		;
	MOV	BX,MSGY2		;
	CALL	LOCATE			; locate.
MSGPRN5:				;
	MOV	AL,DS:[SI]		;
	CALL	CHPUT			;

	INC	CHRPNT			;
	INC	SI			;
	CMP	BYTE PTR DS:[SI],0	; 文字列終わり
	JE	MSGPRN9			;

	CALL	MSG_WINDOW_WAIT		;

	JMP	MSGPRN2			;

MSGPRN9:
	CMP	MSGWIDFLG,1		; 1=メッセージ表示開始
	JE	MSGPRN99		;
	CALL	MUSWAT			; マウスボタンＯＦＦ待ち
	CALL	MUSSHT			; マウス読み込み・ワンショット
	MOV	MSGWIDFLG,1		; 1=メッセージ表示開始
MSGPRN99:

	POP	ES
	POP	SI
	POP	DI
	POP	BP
	POP	DX
	POP	CX
	POP	BX
	POP	AX
	RET
MSGPRN	ENDP



;	ウインドウオープン

MSG_WINDOW_OPEN	PROC	NEAR
	PUSH	AX
	PUSH	BX
	PUSH	CX
	PUSH	DX
	PUSH	SI
	PUSH	DI
	PUSH	ES

	MOV	FLAG_WINDOW_OPEN,1	; ウインドウオープンフラグ 1=OPEN

	CMP	XWINDOW_FLAG,1		; 1=外部ウインドウを使う
	JNE	MSG_WINDOW_OPEN1	;
	CALL	XWINDOW_OPEN		; 外部ウインドウオープン
	JMP	MSG_WINDOW_OPEN_EXIT	; exit.
MSG_WINDOW_OPEN1:			;


	CALL	MSGIN		; メッセージ突入処理

	MOV	AH,35		; Ｘ座標ｍｉｎ
	MOV	AL,10		; Ｙ座標ｍｉｎ
	MOV	BH,44		; Ｘ座標ｍａｘ
	MOV	BL,13		; Ｙ座標ｍａｘ
	MOV	DX,ATR_WID_OP	; テキスト属性
	MOV	CX,10
MSG_WINDOW_OPEN2:
	CALL	MSG_WINDOW_WAIT	;
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AL		; Ｙ座標ｍｉｎ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BL		; Ｙ座標ｍａｘ
	MOV	DX,ATR_WID_NO	; テキスト属性(BLACK)
	CALL	MSG_WINDOW_VW	; ウインドウビュー
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AL		; Ｙ座標ｍｉｎ
	DEC	AL		; Ｙ座標ｍｉｎ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BL		; Ｙ座標ｍａｘ
	INC	BL		; Ｙ座標ｍａｘ
	MOV	DX,ATR_WID_OP	; テキスト属性
	CALL	MSG_WINDOW_VW	; ウインドウビュー
	LOOP	MSG_WINDOW_OPEN2

	MOV	BYTE PTR WINDX1,AH	; Ｘ座標ｍｉｎ
	MOV	BYTE PTR WINDY1,AL	; Ｙ座標ｍｉｎ
	MOV	BYTE PTR WINDX2,BH	; Ｘ座標ｍａｘ
	MOV	BYTE PTR WINDY2,BL	; Ｙ座標ｍａｘ

;*DBG*;	PUSH	SI
;*DBG*;	MOV	AX,5			;
;*DBG*;	MOV	BX,22			;
;*DBG*;	INC	BX			;
;*DBG*;	CALL	LOCATE			; locate.
;*DBG*;	MOV	SI,OFFSET MSG_SYSNAME	; system name.
;*DBG*;	CALL	PRINT
;*DBG*;
;*DBG*;	EXTRN	DECSTR:NEAR
;*DBG*;	MOV	DX,WINDX1
;*DBG*;	CALL	DECSTR
;*DBG*;	CALL	PRINT
;*DBG*;	MOV	DX,WINDY1
;*DBG*;	CALL	DECSTR
;*DBG*;	CALL	PRINT
;*DBG*;	MOV	DX,WINDX2
;*DBG*;	CALL	DECSTR
;*DBG*;	CALL	PRINT
;*DBG*;	MOV	DX,WINDY2
;*DBG*;	CALL	DECSTR
;*DBG*;	CALL	PRINT
;*DBG*;	POP	SI

	MOV	BYTE PTR WINDX1,AH	; Ｘ座標ｍｉｎ
	MOV	BYTE PTR WINDY1,AL	; Ｙ座標ｍｉｎ
	MOV	BYTE PTR WINDX2,BH	; Ｘ座標ｍａｘ
	MOV	BYTE PTR WINDY2,BL	; Ｙ座標ｍａｘ

MSG_WINDOW_OPEN_EXIT:
	POP	ES
	POP	DI
	POP	SI
	POP	DX
	POP	CX
	POP	BX
	POP	AX
	RET
MSG_WINDOW_OPEN	ENDP



;	ウエイト

MSG_WINDOW_WAIT	PROC	NEAR
	PUSH	AX
	PUSH	BX
	PUSH	CX
	PUSH	DX
	MOV	AX,TIME_WINDOW	; ウインドウインターバル時間
	CALL	TMVWT4		; V-SYNC timer4 wait.
	POP	DX
	POP	CX
	POP	BX
	POP	AX
	RET
MSG_WINDOW_WAIT	ENDP



;	ウインドウビュー
;	-I- AH : Ｘ座標ｍｉｎ
;	    AL : Ｙ座標ｍｉｎ
;	    BH : Ｘ座標ｍａｘ
;	    BL : Ｙ座標ｍａｘ
;	    DX : テキスト属性
                             
MSG_WINDOW_VW	PROC	NEAR
	MOV	VX1,0
	MOV	VY1,0
	MOV	VX2,0
	MOV	VY2,0
	MOV	BYTE PTR VX1,AH		; Ｘ座標ｍｉｎ
	MOV	BYTE PTR VY1,AL		; Ｙ座標ｍｉｎ
	MOV	BYTE PTR VX2,BH		; Ｘ座標ｍａｘ
	MOV	BYTE PTR VY2,AL		; Ｙ座標ｍｉｎ
	CALL	TXTBOX			; テキスト属性ＢＯＸセット
	MOV	BYTE PTR VX1,BH		; Ｘ座標ｍａｘ
	MOV	BYTE PTR VY1,AL		; Ｙ座標ｍｉｎ
	MOV	BYTE PTR VX2,BH		; Ｘ座標ｍａｘ
	INC	BYTE PTR VX2
	INC	BYTE PTR VX2
	MOV	BYTE PTR VY2,BL		; Ｙ座標ｍａｘ
	CALL	TXTBOX			; テキスト属性ＢＯＸセット
	MOV	BYTE PTR VX1,AH		; Ｘ座標ｍｉｎ
	MOV	BYTE PTR VY1,BL		; Ｙ座標ｍａｘ
	MOV	BYTE PTR VX2,BH		; Ｘ座標ｍａｘ
	MOV	BYTE PTR VY2,BL		; Ｙ座標ｍａｘ
	CALL	TXTBOX			; テキスト属性ＢＯＸセット
	MOV	BYTE PTR VX1,AH		; Ｘ座標ｍｉｎ
	DEC	BYTE PTR VX1
	DEC	BYTE PTR VX1
	MOV	BYTE PTR VY1,AL		; Ｙ座標ｍｉｎ
	MOV	BYTE PTR VX2,AH		; Ｘ座標ｍｉｎ
	MOV	BYTE PTR VY2,BL		; Ｙ座標ｍａｘ
	CALL	TXTBOX			; テキスト属性ＢＯＸセット
	RET
MSG_WINDOW_VW	ENDP



;	ウインドウクローズ

MSG_WINDOW_CLOSE	PROC	NEAR
	PUSH	AX
	PUSH	BX
	PUSH	CX
	PUSH	DX
	PUSH	SI
	PUSH	DI
	PUSH	ES

	MOV	FLAG_WINDOW_OPEN,0	; ウインドウオープンフラグ 1=OPEN

	CMP	XWINDOW_FLAG,1		; 1=外部ウインドウを使う
	JNE	MSG_WINDOW_CLOSE1	;
	CALL	XWINDOW_CLOSE		; 外部ウインドウクローズ
	JMP	MSG_WINDOW_CLOSE_EXIT	;
MSG_WINDOW_CLOSE1:			;

	MOV	AH,BYTE PTR WINDX1	; Ｘ座標ｍｉｎ
	INC	AH
	MOV	AL,BYTE PTR WINDY1	; Ｙ座標ｍｉｎ
	INC	AL
	MOV	BH,BYTE PTR WINDX2	; Ｘ座標ｍａｘ
	DEC	BH
	MOV	BL,BYTE PTR WINDY2	; Ｙ座標ｍａｘ
	DEC	BL
	MOV	DX,ATR_WID_OP	; テキスト属性
	MOV	CX,10
MSG_WINDOW_CLOSE2:
	CALL	MSG_WINDOW_WAIT	;
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AH		; Ｘ座標ｍｉｎ
	DEC	AL		; Ｙ座標ｍｉｎ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BH		; Ｘ座標ｍａｘ
	INC	BL		; Ｙ座標ｍａｘ
	MOV	DX,ATR_WID_NO	; テキスト属性(BLACK)
	CALL	MSG_WINDOW_VW	; ウインドウビュー
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AH		; Ｘ座標ｍｉｎ
	INC	AL		; Ｙ座標ｍｉｎ
	INC	AL		; Ｙ座標ｍｉｎ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BH		; Ｘ座標ｍａｘ
	DEC	BL		; Ｙ座標ｍａｘ
	DEC	BL		; Ｙ座標ｍａｘ
	MOV	DX,ATR_WID_OP	; テキスト属性
	CALL	MSG_WINDOW_VW	; ウインドウビュー
	LOOP	MSG_WINDOW_CLOSE2

	CALL	CLS
	CALL	MSGOUT		; メッセージ後処理

MSG_WINDOW_CLOSE_EXIT:
	POP	ES
	POP	DI
	POP	SI
	POP	DX
	POP	CX
	POP	BX
	POP	AX
	RET
MSG_WINDOW_CLOSE	ENDP



;	メッセージスタート

MSG_START	PROC	NEAR
	MOV	MSGWIDFLG,0		; 1=メッセージ表示開始
	CALL	USER_STANBY_SETUP	; ユーザ、スタンバイセットアップ
	RET
MSG_START	ENDP



;	メッセージストップ

MSG_STOP	PROC	NEAR
	CMP	MSGWIDFLG,0		; 1=メッセージ表示開始
	JE	MSG_STOP9
	CALL	MSG_WINDOW_CLOSE	; ウインドウクローズ
	MOV	MSGWIDFLG,0		; 1=メッセージ表示開始
MSG_STOP9:
	RET
MSG_STOP	ENDP



;	見つからないメッセージ

DKCMSG	PROC	NEAR
	CMP	FLAG_ERR_OUT,1		; 0=エラー表示抑制,1=エラー表示
	JE	DKCMSG0			;
	RET
DKCMSG0:
	PUSH	SI
	PRINTM	"ファイルが見つかりません"
	MOV	SI,FILE_NAME_ADRS	; ファイル名
	PRINTSI

	MOV	AX,TIME_DKCMSG		; メッセージ時間
	CALL	TMVWT4			; V-SYNC timer4 wait.

	POP	SI
	RET
DKCMSG	ENDP


;	メッセージ突入モード
;	-I- DX : 0=何もしない, 1=５０％ダウン

DKCMMD	PROC	NEAR
;*;	MOV	MODEMSG,DX	; 0=何もしない, 1=５０％ダウン

	MOV	MODEMSG,0	; 0=何もしない, 1=５０％ダウン

	MOV	AX,DX		; 1=外部ウインドウを使う,
				; 0=内部のウインドウを使う
	CALL	DKCWID		; 表示するウインドウの選択

	RET
DKCMMD	ENDP



;	メッセージ突入処理
;	-I- MODEMSG : 0=何もしない, 1=５０％ダウン

MSGIN	PROC	NEAR
	CMP	MODEMSG,1	; 0=何もしない, 1=５０％ダウン
	JE	MSGIN1		;
	RET
MSGIN1:
	CALL	BRIOUT		; 明度５０％ダウン
	RET
MSGIN	ENDP



;	メッセージ後処理
;	-I- MODEMSG : 0=何もしない, 1=５０％ダウン

MSGOUT	PROC	NEAR
	CMP	MODEMSG,1	; 0=何もしない, 1=５０％ダウン
	JE	MSGOUT1		;
	RET
MSGOUT1:
	CALL	BRIIN		; 明度５０％からノーマルへ
	RET
MSGOUT	ENDP


;	表示するウインドウの選択
;	-I- AX : 1=外部ウインドウを使う,0=内部のウインドウを使う

DKCWID	PROC	NEAR
	MOV	XWINDOW_FLAG,AX		; 1=外部ウインドウを使う
	RET
DKCWID	ENDP



;	外部ウインドウオープン

XWINDOW_OPEN	PROC	NEAR
	MOV	BX,1			; 1=ウインドウ・オープン
	CALL	WIDDISK			; WINDOWS/ディスクウインドウ
;*;	CALL	WIDMES			; メッセージ・ウインドウ

	MOV	XWINDOW_LINE,0		; 外部ウインドウ使用行

	RET
XWINDOW_OPEN	ENDP


;	外部ウインドウクローズ

XWINDOW_CLOSE	PROC	NEAR
	MOV	BX,2			; 2=ウインドウ・クローズ
	CALL	WIDDISK			; WINDOWS/ディスクウインドウ
;*;	CALL	WIDMES			; メッセージ・ウインドウ
	RET
XWINDOW_CLOSE	ENDP


;	外部ウインドウ表示
;	-I- SI : 文字列

XWINDOW_START	PROC	NEAR
	CMP	MSGWIDFLG,0		; 1=メッセージ表示開始
	JNE	XWINDOW_START001	;
	PUSH	SI			;
	CALL	MSG_WINDOW_OPEN		; ウインドウオープン
	POP	SI			;
XWINDOW_START001:			;
	CMP	XWINDOW_LINE,1		; 外部ウインドウ使用行
	JE	XWINDOW_START1		;
	MOV	BX,3			; 3=ウインドウ・メッセージ／上段
	MOV	XWINDOW_LINE,1		; 外部ウインドウ使用行
	JMP	XWINDOW_START2		;
XWINDOW_START1:				;
	MOV	BX,4			; 4=ウインドウ・メッセージ／中段
	MOV	XWINDOW_LINE,0		; 外部ウインドウ使用行
XWINDOW_START2:				;
	PUSH	SI			;
	CALL	WIDDISK			; WINDOWS/ディスクウインドウ
;*;	CALL	WIDMES			; メッセージ・ウインドウ
	POP	SI			;
	RET
XWINDOW_START	ENDP


;	ユーザ、スタンバイセットアップ

USER_STANBY_SETUP	PROC	NEAR
	MOV	USER_ST_COUNT,0		; ユーザスタンバイカウンタ
	RET
USER_STANBY_SETUP	ENDP


;	ユーザから直接、スタンバイが出た
;	-O- BX : 1=スタンバイ,0=通常

USER_STANBY	PROC	NEAR
	CMP	FLAG_WINDOW_OPEN,1	; ウインドウオープンフラグ 1=OPEN
	JE	USER_STANBY_START	;
	MOV	BX,0			; 0=通常
	RET
USER_STANBY_START:
	PUSH	AX
	PUSH	CX
	PUSH	DX
	PUSH	BP
	PUSH	SI
	PUSH	DI
	PUSH	ES

	CMP	USER_ST_COUNT,0		; ユーザスタンバイカウンタ
	JNE	USER_STANBY_9		;


	CALL	MUSSHT			; マウス読み込み・ワンショット
	CMP	DH,0			; 左ボタン（1：ＯＦＦ／0：ＯＮ）
	JE	USER_STANBY_8		;
	CMP	DL,0			; 右ボタン（1：ＯＦＦ／0：ＯＮ）
	JE	USER_STANBY_8		;

USER_STANBY_7:				;
	MOV	BX,0			; 0=通常
	JMP	USER_STANBY_EXIT	;
USER_STANBY_8:				;
	MOV	AX,DRVNUMMAX		; １ＭＦＤドライブ数
	DEC	AX			;
	MOV	USER_ST_COUNT,AX	; ユーザスタンバイカウンタ
	MOV	BX,1			; 1=スタンバイ
	JMP	USER_STANBY_EXIT	;
USER_STANBY_9:				;
	DEC	USER_ST_COUNT		; ユーザスタンバイカウンタ
	MOV	BX,1			; 1=スタンバイ
USER_STANBY_EXIT:
	POP	ES
	POP	DI
	POP	SI
	POP	BP
	POP	DX
	POP	CX
	POP	AX
	RET
USER_STANBY	ENDP


;*;;	ディスクステータス
;*;
;*;DUMP_DISK	PROC	NEAR
;*;	MOV	AX,0		;
;*;	MOV	ES,AX		;
;*;	LC	0,2
;*;	PRVV	"UNIT#0:",<ES:[564H]>
;*;	PRVV	"UNIT#1:",<ES:[564H+8]>
;*;	PRVV	"UNIT#2:",<ES:[564H+8*2]>
;*;	PRVV	"UNIT#3:",<ES:[564H+8*3]>
;*;
;*;	RET
;*;DUMP_DISK	ENDP


CODE	ENDS




DATA	SEGMENT	PUBLIC	'DATA'

PUBLIC	DRIVENAME_SFT		; ドライブ名と2HDユニット番号のズレ

EXTRN	VX1:WORD		; source point x1.
EXTRN	VY1:WORD		; source point y1.
EXTRN	VX2:WORD		; length x2.
EXTRN	VY2:WORD		; length y2.

;	セクタバッファ（ＤＭＡバッファ）
;	ＤＭＡバウンダリエラーを避ける為、SCDATA2 を CMDTBL.ASM へ移動した。
	EVEN
PUBLIC	SCDATA					; セクタバッファ
EXTRN	SCDATA2:BYTE				; セクタバッファ
SCADRS	DW	OFFSET SCDATA			; セクタバッファアドレス
SCDATA		DB	SEC_BYTE DUP (0)	; セクタバッファ
;SCDATA2	DB	SEC_BYTE DUP (0)	; セクタバッファ
	DB	0,0

	EVEN
; ＢＩＯＳコマンド識別コード
;		MM-S....
;		TFrK0110
DREAD	DW	11110110B	; ＲＥＡＤ　ＤＡＴＡ
;*N*;DRECAL	DW	00100111B	; ＲＥＣＡＬＩＢＲＡＴＥ
DRECAL	DW	00000111B	; ＲＥＣＡＬＩＢＲＡＴＥ
DWRITE	DW	01010101B	; ＷＲＩＴＥＤＡＴＡ

DSENSE	DW	04H		; ＳＥＮＳＥ
DSEEK	DW	10H		; ＳＥＥＫ

DSENSE_NEW DW	84H		; ＳＥＮＳＥ（ＣＯＭＭＡＮＤ／ＳＴＡＴＵＳ）

;		100100dd
DUNIT	DW	10010001B	; デバイス識別・ユニット番号（DA/UA）

;	ＩＤＲ（ＩＤ情報）
DLEN	DW	SEC_BYTE	; データ長（ＤＴＬ）（バイト単位）
DCYL	DW	0		; シリンダ番号（Ｃ）０ー７６
DHEAD	DW	0		; ヘッド番号（Ｈ）０ー１
DSECR	DW	1		; セクタ番号（Ｒ）１ー８（２６）
DSECN	DW	03		; セクタ長（Ｎ）
				; 00/128, 01/256, 02/512, 03/1024
DSTAT	DW	0		; ステータス情報
DERROR	DW	0		; 0=正常,1=エラー


DISK_DOOR_INI	DB	0FFH,0FFH,0FFH,0FFH	; ディスク開閉初期ﾌﾗｸﾞ

	EVEN
READ_RETRY	DW	0	; リード・リトライカウンタ
WRITE_RETRY	DW	0	; セクタ書き込み・リトライカウンタ

BUFF_SEG	DW	0	; バッファセグメント
BUFF_OFFSET	DW	0	; バッファオフセット


DSKID_ADRS	LABEL	WORD		; ディスクＩＤアドレステーブル
	DW	OFFSET DSKID0		;
	DW	OFFSET DSKID1		;
	DW	OFFSET DSKID2		;
	DW	OFFSET DSKID3		;
DSKID0	DB	ID_LEN DUP (0)		; ドライブ０のＩＤテーブル
DSKID1	DB	ID_LEN DUP (0)		; ドライブ１のＩＤテーブル
DSKID2	DB	ID_LEN DUP (0)		; ドライブ２のＩＤテーブル
DSKID3	DB	ID_LEN DUP (0)		; ドライブ３のＩＤテーブル

	EVEN
ID_DISKSYSNAME	DW	0		; システムＩＤ
ID_DISKPROG	DW	0		; プログラムＩＤ
ID_DISKNUMBER	DW	0		; ディスク番号

DRIVENAME_TBL	DB	"ABCDEFGHIJ"	; ドライブ名テーブル 0=A,1=B,2=C,3=D
DRIVENAME_SFT	DB	0,0		; ドライブ名と2HDユニット番号のズレ

DRVNUMMAX	DW	DRVNUMMAX_FIX	; １ＭＦＤドライブ数
DRVNUM		DW	0		; ドライブ番号（０ー３）
DRVNUMSYS	DW	0		; システムドライブ番号

SCH_DISKID	DW	0		; 検索ディスクＩＤ

FLNAME		DB	"        "	; ファイル名
FLTYPE		DB	"   ",0		; 拡張子

		EVEN
DIRDISK		DW	0		; 対象ディスク番号

DIRNAME		DB	"           ",0	; 対象ファイル名

DIRHANDLEPATH	DB	14 DUP (0),0,0	; ハンドル用パス名 "A:12345678.123",0

SYSDIRPATH	LABEL	BYTE		; ディレクトリィファイル・パス名
SYSDIRDRIVE	DB	"A:"		; ディレクトリィファイル・ドライブ名
SYSDIRNAM	DB	"SYSTEM.DIR",0	; ディレクトリィファイル名

DOSCALLX_DUMMY	DB	"A:XXXXYYYY.AAA",0 ; ＤＯＳアクセス用ダミー

					; ID length=8
DOSXSTOP	DB	"$dosxstop",0	; 標準ＤＯＳのアクセスを止めます
ERRORDSP	DB	"$errordsp",0	; エラー表示ＯＮ
UNIT0		DB	"$unit0=",0	; ユニット＃０はドライブ何"$unit0="


;	ディレクトリィファイルをオンメモリーに持つことにする

DIRTABLE	LABEL	WORD		; ディレクトリィテーブル
;*;	DB	DIRTABLE_MAX*DIRTABLE_NM_LEN DUP (0)
DB	"-------------",0DH,0AH
DB	"system by r.h",0DH,0AH
DB	" (C)1991.02  ",0DH,0AH
DB	"dirctory file",0DH,0AH
DB	"==$dosxstop  ",0DH,0AH
DB	"$errordsp    ",0DH,0AH
DB	"$unit0=A:    ",0DH,0AH
DB	"-disk1-------",0DH,0AH
DB	"< file ><a>RD",0DH,0AH
DB	"BTN     PT11 ",0DH,0AH
DB	"BTNWK   PT11 ",0DH,0AH
DB	"BTNSCD  PT11 ",0DH,0AH
DB	"BTNSCW  PT11 ",0DH,0AH
DB	"CLEND   PT11 ",0DH,0AH
DB	"FREAMB1 PT11 ",0DH,0AH
DB	"FREAMB2 PT11 ",0DH,0AH
DB	"FREAMB3 PT11 ",0DH,0AH
DB	"FREAMM1 PT11 ",0DH,0AH
DB	"FREAMM2 PT11 ",0DH,0AH
DB	"FREAMM3 PT11 ",0DH,0AH
DB	"FREAMD  PT11 ",0DH,0AH
DB	"FREAMU1 PT11 ",0DH,0AH
DB	"FREAMU2 PT11 ",0DH,0AH
DB	"GRAPH   PT11 ",0DH,0AH
DB	"VALUE   PT11 ",0DH,0AH
DB	"KAZARI  PT11 ",0DH,0AH
DB	"PALET   PT11 ",0DH,0AH
DB	"PAT6    PT11 ",0DH,0AH
DB	"PAT7    PT11 ",0DH,0AH
DB	"PAT7WK  PT11 ",0DH,0AH
DB	"PAT8    PT11 ",0DH,0AH
DB	"BLOOD   PT11 ",0DH,0AH
DB	"MONTH   PT11 ",0DH,0AH
DB	"WEEK    PT11 ",0DH,0AH
DB	"BIGNUM  PT11 ",0DH,0AH
DB	"PROPR   PT11 ",0DH,0AH
DB	"PROP2   PT11 ",0DH,0AH
DB	"I1_01   PT11 ",0DH,0AH
DB	"I1_02   PT11 ",0DH,0AH
DB	"I1_03   PT11 ",0DH,0AH
DB	"I1_04   PT11 ",0DH,0AH
DB	"I1_05   PT11 ",0DH,0AH
DB	"I1_06   PT11 ",0DH,0AH
DB	"I1_07   PT11 ",0DH,0AH
DB	"I1_08   PT11 ",0DH,0AH
DB	"I1_09   PT11 ",0DH,0AH
DB	"I1_10   PT11 ",0DH,0AH
DB	"I1_11   PT11 ",0DH,0AH
DB	"I1_12   PT11 ",0DH,0AH
DB	"I2_01   PT11 ",0DH,0AH
DB	"I2_02   PT11 ",0DH,0AH
DB	"I2_03   PT11 ",0DH,0AH
DB	"I3_01   PT11 ",0DH,0AH
DB	"I4_01   PT11 ",0DH,0AH
DB	"I4_02   PT11 ",0DH,0AH
DB	"I4_05   PT11 ",0DH,0AH
DB	"PM1     M  1 ",0DH,0AH
DB	"PM2     M  1 ",0DH,0AH
DB	"PM3     M  1 ",0DH,0AH
DB	"PM4     M  1 ",0DH,0AH
DB	"PM5     M  1 ",0DH,0AH
DB	"PM6     M  1 ",0DH,0AH
DB	"PM7     M  1 ",0DH,0AH
DB	"PM8     M  1 ",0DH,0AH
DB	"PM9     M  1 ",0DH,0AH
DB	"PM10    M  1 ",0DH,0AH
DB	"PM11    M  1 ",0DH,0AH
DB	"PM12    M  1 ",0DH,0AH
DB	"PM13    M  1 ",0DH,0AH
DB	"PM14    M  1 ",0DH,0AH
DB	"PM15    M  1 ",0DH,0AH
DB	"E2_01   PT11 ",0DH,0AH
DB	"E2_02   PT11 ",0DH,0AH
DB	"E2_03   PT11 ",0DH,0AH
DB	"E2_04   PT11 ",0DH,0AH
DB	"E2_05   PT11 ",0DH,0AH
DB	"E2_06   PT11 ",0DH,0AH
DB	"E2_07   PT11 ",0DH,0AH
DB	"E2_08   PT11 ",0DH,0AH
DB	"E2_09   PT11 ",0DH,0AH
DB	"E2_10   PT11 ",0DH,0AH
DB	"E3_01   PT11 ",0DH,0AH
DB	"E3_02   PT11 ",0DH,0AH
DB	"E3_03   PT11 ",0DH,0AH
DB	"F1_01   PT11 ",0DH,0AH
DB	"F1_02   PT11 ",0DH,0AH
DB	"F1_03   PT11 ",0DH,0AH
DB	"F1_04   PT11 ",0DH,0AH
DB	"F1_05   PT11 ",0DH,0AH
DB	"F1_06   PT11 ",0DH,0AH
DB	"F2_01   PT11 ",0DH,0AH
DB	"F2_02   PT11 ",0DH,0AH
DB	"F2_03   PT11 ",0DH,0AH
DB	"F2_04   PT11 ",0DH,0AH
DB	"F2_05   PT11 ",0DH,0AH
DB	"F3_01   PT11 ",0DH,0AH
DB	"F3_02   PT11 ",0DH,0AH
DB	"F3_03   PT11 ",0DH,0AH
DB	"F3_04   PT11 ",0DH,0AH
DB	"F3_05   PT11 ",0DH,0AH
DB	"F3_06   PT11 ",0DH,0AH
DB	"F3_07   PT11 ",0DH,0AH
DB	"F3_08   PT11 ",0DH,0AH
DB	"F3_09   PT11 ",0DH,0AH
DB	"F3_10   PT11 ",0DH,0AH
DB	"F3_11   PT11 ",0DH,0AH
DB	"F3_12   PT11 ",0DH,0AH
DB	"F4_01   PT11 ",0DH,0AH
DB	"F4_02   PT11 ",0DH,0AH
DB	"F4_03   PT11 ",0DH,0AH
DB	"F4_04   PT11 ",0DH,0AH
DB	"F5_01   PT11 ",0DH,0AH
DB	"F5_02   PT11 ",0DH,0AH
DB	"F5_03   PT11 ",0DH,0AH
DB	"F5_04   PT11 ",0DH,0AH
DB	"MBG6L   PT11 ",0DH,0AH
DB	"MBG6R   PT11 ",0DH,0AH
DB	"FDTOOL  COM1 ",0DH,0AH
DB	"MUSYA   COM1 ",0DH,0AH
DB	"-disk2-------",0DH,0AH
DB	"WOPENBORPT12 ",0DH,0AH
DB	"XOPENBORPT12 ",0DH,0AH
DB	"WOPENCUTPT12 ",0DH,0AH
DB	"XOPENCUTPT12 ",0DH,0AH
DB	"WOPENNAMPT12 ",0DH,0AH
DB	"XOPENNAMPT12 ",0DH,0AH
DB	"C1      PT12 ",0DH,0AH
DB	"C2      PT12 ",0DH,0AH
DB	"C3      PT12 ",0DH,0AH
DB	"C4      PT12 ",0DH,0AH
DB	"C5A1    PT12 ",0DH,0AH
DB	"C5A2    PT12 ",0DH,0AH
DB	"MBG1L   PT12 ",0DH,0AH
DB	"MBG1R   PT12 ",0DH,0AH
DB	"CB1     PT12 ",0DH,0AH
DB	"CB1D1   PT12 ",0DH,0AH
DB	"CB1D2   PT12 ",0DH,0AH
DB	"CB1D3   PT12 ",0DH,0AH
DB	"CB1D4   PT12 ",0DH,0AH
DB	"CB1F1   PT12 ",0DH,0AH
DB	"CB1F2   PT12 ",0DH,0AH
DB	"CB1F3   PT12 ",0DH,0AH
DB	"CB2     PT12 ",0DH,0AH
DB	"CB2D1   PT12 ",0DH,0AH
DB	"CB2D2   PT12 ",0DH,0AH
DB	"CB2D3   PT12 ",0DH,0AH
DB	"CB2D4   PT12 ",0DH,0AH
DB	"CB2F1   PT12 ",0DH,0AH
DB	"CB2F2   PT12 ",0DH,0AH
DB	"CB2F3   PT12 ",0DH,0AH
DB	"XC1-01  PT12 ",0DH,0AH
DB	"WC1-01  PT12 ",0DH,0AH
DB	"XC1-02  PT12 ",0DH,0AH
DB	"WC1-02  PT12 ",0DH,0AH
DB	"XC1-03  PT12 ",0DH,0AH
DB	"WC1-03  PT12 ",0DH,0AH
DB	"XC1-04  PT12 ",0DH,0AH
DB	"WC1-04  PT12 ",0DH,0AH
DB	"WINDOW1 COM2 ",0DH,0AH
DB	"NAMEFILEEMS2 ",0DH,0AH
DB	"-disk3-------",0DH,0AH
DB	"MBG1L_2 PT13 ",0DH,0AH
DB	"MBG1R_2 PT13 ",0DH,0AH
DB	"CB3     PT13 ",0DH,0AH
DB	"CB3D1   PT13 ",0DH,0AH
DB	"CB3D2   PT13 ",0DH,0AH
DB	"CB3D3   PT13 ",0DH,0AH
DB	"CB3D4   PT13 ",0DH,0AH
DB	"CB3F1   PT13 ",0DH,0AH
DB	"CB3F2   PT13 ",0DH,0AH
DB	"CB3F3   PT13 ",0DH,0AH
DB	"CB4     PT13 ",0DH,0AH
DB	"CB4D1   PT13 ",0DH,0AH
DB	"CB4D2   PT13 ",0DH,0AH
DB	"CB4D3   PT13 ",0DH,0AH
DB	"CB4D4   PT13 ",0DH,0AH
DB	"CB4F1   PT13 ",0DH,0AH
DB	"CB4F2   PT13 ",0DH,0AH
DB	"CB4F3   PT13 ",0DH,0AH
DB	"XC2-01  PT13 ",0DH,0AH
DB	"WC2-01  PT13 ",0DH,0AH
DB	"XC2-02  PT13 ",0DH,0AH
DB	"WC2-02  PT13 ",0DH,0AH
DB	"XC2-03  PT13 ",0DH,0AH
DB	"WC2-03  PT13 ",0DH,0AH
DB	"XC2-04  PT13 ",0DH,0AH
DB	"WC2-04  PT13 ",0DH,0AH
DB	"L1_07   PT13 ",0DH,0AH
DB	"L1_08   PT13 ",0DH,0AH
DB	"L1_09   PT13 ",0DH,0AH
DB	"L1_10   PT13 ",0DH,0AH
DB	"L1_11   PT13 ",0DH,0AH
DB	"L1_12   PT13 ",0DH,0AH
DB	"L2_07   PT13 ",0DH,0AH
DB	"L2_08   PT13 ",0DH,0AH
DB	"L2_09   PT13 ",0DH,0AH
DB	"L2_10   PT13 ",0DH,0AH
DB	"L2_11   PT13 ",0DH,0AH
DB	"L2_12   PT13 ",0DH,0AH
DB	"L3_07   PT13 ",0DH,0AH
DB	"L3_08   PT13 ",0DH,0AH
DB	"L3_09   PT13 ",0DH,0AH
DB	"L3_10   PT13 ",0DH,0AH
DB	"L3_11   PT13 ",0DH,0AH
DB	"L3_12   PT13 ",0DH,0AH
DB	"-disk4-------",0DH,0AH
DB	"MBG1L_3 PT14 ",0DH,0AH
DB	"MBG1R_3 PT14 ",0DH,0AH
DB	"CB5     PT14 ",0DH,0AH
DB	"CB5D1   PT14 ",0DH,0AH
DB	"CB5D2   PT14 ",0DH,0AH
DB	"CB5D3   PT14 ",0DH,0AH
DB	"CB5D4   PT14 ",0DH,0AH
DB	"CB5F1   PT14 ",0DH,0AH
DB	"CB5F2   PT14 ",0DH,0AH
DB	"CB5F3   PT14 ",0DH,0AH
DB	"CB6     PT14 ",0DH,0AH
DB	"CB6D1   PT14 ",0DH,0AH
DB	"CB6D2   PT14 ",0DH,0AH
DB	"CB6D3   PT14 ",0DH,0AH
DB	"CB6D4   PT14 ",0DH,0AH
DB	"CB6F1   PT14 ",0DH,0AH
DB	"CB6F2   PT14 ",0DH,0AH
DB	"CB6F3   PT14 ",0DH,0AH
DB	"XC3-01  PT14 ",0DH,0AH
DB	"WC3-01  PT14 ",0DH,0AH
DB	"XC3-02  PT14 ",0DH,0AH
DB	"WC3-02  PT14 ",0DH,0AH
DB	"XC3-03  PT14 ",0DH,0AH
DB	"WC3-03  PT14 ",0DH,0AH
DB	"XC3-04  PT14 ",0DH,0AH
DB	"WC3-04  PT14 ",0DH,0AH
DB	"L1_25   PT14 ",0DH,0AH
DB	"L1_26   PT14 ",0DH,0AH
DB	"L1_27   PT14 ",0DH,0AH
DB	"L1_28   PT14 ",0DH,0AH
DB	"L1_29   PT14 ",0DH,0AH
DB	"L1_30   PT14 ",0DH,0AH
DB	"L2_25   PT14 ",0DH,0AH
DB	"L2_26   PT14 ",0DH,0AH
DB	"L2_27   PT14 ",0DH,0AH
DB	"L2_28   PT14 ",0DH,0AH
DB	"L2_29   PT14 ",0DH,0AH
DB	"L2_30   PT14 ",0DH,0AH
DB	"L3_25   PT14 ",0DH,0AH
DB	"L3_26   PT14 ",0DH,0AH
DB	"L3_27   PT14 ",0DH,0AH
DB	"L3_28   PT14 ",0DH,0AH
DB	"L3_29   PT14 ",0DH,0AH
DB	"L3_30   PT14 ",0DH,0AH
DB	"-disk5-------",0DH,0AH
DB	"MBG1L_4 PT15 ",0DH,0AH
DB	"MBG1R_4 PT15 ",0DH,0AH
DB	"CB7     PT15 ",0DH,0AH
DB	"CB7D1   PT15 ",0DH,0AH
DB	"CB7D2   PT15 ",0DH,0AH
DB	"CB7D3   PT15 ",0DH,0AH
DB	"CB7D4   PT15 ",0DH,0AH
DB	"CB7F1   PT15 ",0DH,0AH
DB	"CB7F2   PT15 ",0DH,0AH
DB	"CB7F3   PT15 ",0DH,0AH
DB	"CB8     PT15 ",0DH,0AH
DB	"CB8D1   PT15 ",0DH,0AH
DB	"CB8D2   PT15 ",0DH,0AH
DB	"CB8D3   PT15 ",0DH,0AH
DB	"CB8D4   PT15 ",0DH,0AH
DB	"CB8F1   PT15 ",0DH,0AH
DB	"CB8F2   PT15 ",0DH,0AH
DB	"CB8F3   PT15 ",0DH,0AH
DB	"XC4-01  PT15 ",0DH,0AH
DB	"WC4-01  PT15 ",0DH,0AH
DB	"XC4-02  PT15 ",0DH,0AH
DB	"WC4-02  PT15 ",0DH,0AH
DB	"XC4-03  PT15 ",0DH,0AH
DB	"WC4-03  PT15 ",0DH,0AH
DB	"XC4-04  PT15 ",0DH,0AH
DB	"WC4-04  PT15 ",0DH,0AH
DB	"L1_01   PT15 ",0DH,0AH
DB	"L1_02   PT15 ",0DH,0AH
DB	"L1_03   PT15 ",0DH,0AH
DB	"L1_04   PT15 ",0DH,0AH
DB	"L1_05   PT15 ",0DH,0AH
DB	"L1_06   PT15 ",0DH,0AH
DB	"L2_01   PT15 ",0DH,0AH
DB	"L2_02   PT15 ",0DH,0AH
DB	"L2_03   PT15 ",0DH,0AH
DB	"L2_04   PT15 ",0DH,0AH
DB	"L2_05   PT15 ",0DH,0AH
DB	"L2_06   PT15 ",0DH,0AH
DB	"L3_01   PT15 ",0DH,0AH
DB	"L3_02   PT15 ",0DH,0AH
DB	"L3_03   PT15 ",0DH,0AH
DB	"L3_04   PT15 ",0DH,0AH
DB	"L3_05   PT15 ",0DH,0AH
DB	"L3_06   PT15 ",0DH,0AH
DB	"OCHITEXTTXT5 ",0DH,0AH
DB	"-disk6-ｼｭｳｶｸ-",0DH,0AH
DB	"MBG2L   PT16 ",0DH,0AH
DB	"MBG2R   PT16 ",0DH,0AH
DB	"MC_01   PT16 ",0DH,0AH
DB	"MC_02   PT16 ",0DH,0AH
DB	"MC_03   PT16 ",0DH,0AH
DB	"MC_04   PT16 ",0DH,0AH
DB	"MC_05   PT16 ",0DH,0AH
DB	"MC_06   PT16 ",0DH,0AH
DB	"MC_07   PT16 ",0DH,0AH
DB	"MC_08   PT16 ",0DH,0AH
DB	"MC_09   PT16 ",0DH,0AH
DB	"MC_10   PT16 ",0DH,0AH
DB	"MC_11   PT16 ",0DH,0AH
DB	"MC_12   PT16 ",0DH,0AH
DB	"MC_13   PT16 ",0DH,0AH
DB	"MC_14   PT16 ",0DH,0AH
DB	"MC_15   PT16 ",0DH,0AH
DB	"MC_16   PT16 ",0DH,0AH
DB	"MC_17   PT16 ",0DH,0AH
DB	"MC_18   PT16 ",0DH,0AH
DB	"MC_19   PT16 ",0DH,0AH
DB	"MC_20   PT16 ",0DH,0AH
DB	"MC_21   PT16 ",0DH,0AH
DB	"MC_22   PT16 ",0DH,0AH
DB	"MC_23   PT16 ",0DH,0AH
DB	"MC_24   PT16 ",0DH,0AH
DB	"MC_25   PT16 ",0DH,0AH
DB	"E1_01   PT16 ",0DH,0AH
DB	"E1_02   PT16 ",0DH,0AH
DB	"E1_03   PT16 ",0DH,0AH
DB	"E1_04   PT16 ",0DH,0AH
DB	"E1_05   PT16 ",0DH,0AH
DB	"E1_06   PT16 ",0DH,0AH
DB	"E1_07   PT16 ",0DH,0AH
DB	"E1_08   PT16 ",0DH,0AH
DB	"E1_09   PT16 ",0DH,0AH
DB	"E1_10   PT16 ",0DH,0AH
DB	"E1_11   PT16 ",0DH,0AH
DB	"E1_12   PT16 ",0DH,0AH
DB	"E1_13   PT16 ",0DH,0AH
DB	"E1_14   PT16 ",0DH,0AH
DB	"E1_15   PT16 ",0DH,0AH
DB	"E1_16   PT16 ",0DH,0AH
DB	"E1_17   PT16 ",0DH,0AH
DB	"E1_18   PT16 ",0DH,0AH
DB	"E1_19   PT16 ",0DH,0AH
DB	"E1_20   PT16 ",0DH,0AH
DB	"E1_21   PT16 ",0DH,0AH
DB	"E1_22   PT16 ",0DH,0AH
DB	"E1_23   PT16 ",0DH,0AH
DB	"PAT10S1 PT16 ",0DH,0AH
DB	"PAT10S2 PT16 ",0DH,0AH
DB	"PAT10S3 PT16 ",0DH,0AH
DB	"PAT10S4 PT16 ",0DH,0AH
DB	"PAT10S5 PT16 ",0DH,0AH
DB	"FREAMBT1PT16 ",0DH,0AH
DB	"FREAMBT2PT16 ",0DH,0AH
DB	"FREAMC1 PT16 ",0DH,0AH
DB	"FREAMC2 PT16 ",0DH,0AH
DB	"-disk7---ｵﾁ--",0DH,0AH
DB	"L1_13   PT17 ",0DH,0AH
DB	"L1_14   PT17 ",0DH,0AH
DB	"L1_15   PT17 ",0DH,0AH
DB	"L1_16   PT17 ",0DH,0AH
DB	"L1_17   PT17 ",0DH,0AH
DB	"L1_18   PT17 ",0DH,0AH
DB	"L1_19   PT17 ",0DH,0AH
DB	"L1_20   PT17 ",0DH,0AH
DB	"L1_21   PT17 ",0DH,0AH
DB	"L1_22   PT17 ",0DH,0AH
DB	"L1_23   PT17 ",0DH,0AH
DB	"L1_24   PT17 ",0DH,0AH
DB	"L2_13   PT17 ",0DH,0AH
DB	"L2_14   PT17 ",0DH,0AH
DB	"L2_15   PT17 ",0DH,0AH
DB	"L2_16   PT17 ",0DH,0AH
DB	"L2_17   PT17 ",0DH,0AH
DB	"L2_18   PT17 ",0DH,0AH
DB	"L2_19   PT17 ",0DH,0AH
DB	"L2_20   PT17 ",0DH,0AH
DB	"L2_21   PT17 ",0DH,0AH
DB	"L2_22   PT17 ",0DH,0AH
DB	"L2_23   PT17 ",0DH,0AH
DB	"L2_24   PT17 ",0DH,0AH
DB	"L3_13   PT17 ",0DH,0AH
DB	"L3_14   PT17 ",0DH,0AH
DB	"L3_15   PT17 ",0DH,0AH
DB	"L3_16   PT17 ",0DH,0AH
DB	"L3_17   PT17 ",0DH,0AH
DB	"L3_18   PT17 ",0DH,0AH
DB	"L3_19   PT17 ",0DH,0AH
DB	"L3_20   PT17 ",0DH,0AH
DB	"L3_21   PT17 ",0DH,0AH
DB	"L3_22   PT17 ",0DH,0AH
DB	"L3_23   PT17 ",0DH,0AH
DB	"L3_24   PT17 ",0DH,0AH
DB	"-------------",0DH,0AH
	DB	10*DIRTABLE_NM_LEN DUP (0)
	DB	0,0
	DB	0,0

MSG_SYSNAME1	DB	"ｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧ",0
MSG_SYSNAME2	DB	"    EXELOAD PRG system view ver0.2    ",0
MSG_SYSNAME3	DB	"ｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧｧ",0


		EVEN
DOSSTP		DW	0	; 0=通常,1=標準ＤＯＳのアクセスを止めます
FLAG_ERR_OUT	DW	1	; 0=エラー表示抑制,1=エラー表示

FILE_NAME_ADRS	DW	0	; ファイル名

CHRPNT		DW	0	; キャラクタポインタ
MSGWIDFLG	DW	0	; 1=メッセージ表示開始

MODEMSG		DW	1	; 0=何もしない, 1=５０％ダウン

FLAG_WINDOW_OPEN DW	0	; ウインドウオープンフラグ 1=OPEN

XWINDOW_FLAG	DW	0	; 1=外部ウインドウを使う
XWINDOW_LINE	DW	0	; 外部ウインドウ使用行

WINDX1		DW	0	; Ｘ座標ｍｉｎ
WINDY1		DW	0	; Ｙ座標ｍｉｎ
WINDX2		DW	0	; Ｘ座標ｍａｘ
WINDY2		DW	0	; Ｙ座標ｍａｘ

USER_ST_COUNT	DW	0	; ユーザスタンバイカウンタ

FLAG_RAM_DR	DW	0	; RAMドライブ接続 1=接続されている,0=接続無し

;*NON*;MSGER0	DB	"[ ﾜｶﾗﾅｲｴﾗｰ ]",CHR_CR,CHR_LF,0
;*NON*;MSGER1	DB	"[ ｼｰｸｴﾗｰ ]",CHR_CR,CHR_LF,0
;*NON*;MSGER2	DB	"[ read error ]",CHR_CR,CHR_LF,0
;*NON*;MSGER3	DB	"[ write error ]",CHR_CR,CHR_LF,0
;*NON*;MSGER4	DB	"[ ﾌｧｲﾙ ｶﾞ ﾐﾂｶﾗﾅｲ ]",CHR_CR,CHR_LF,0

DATA	ENDS
	END
;
;	end of "DSKCHG.ASM"
;
